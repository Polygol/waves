<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="favicon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Waves</title>
    <script src="/assets/gurapp/api/gurasuraisu-api.js"></script>
    <!-- MapLibre GL JS for Map Display -->
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,700,1,0">

    <style>
        :root {
            --edge-refraction-filter: url('#edge-refraction-only');
            --sun-shadow: 0 0 0 0 transparent;
            --background-color-dark: #1c1c1c;
            --text-color-dark: #f9f9f9;
            --secondary-text-color-dark: rgba(255, 255, 255, 0.7);
            --modal-background-dark: rgba(51, 51, 51, 0.8);
            --modal-transparent-dark: rgba(51, 51, 51, 0.7);
            --search-background-dark: rgba(51, 51, 51, 0.5);
            --dark-overlay: rgba(51, 51, 51, 0.2);
            --dark-transparent: rgba(255, 255, 255, 0.1);
            --glass-border-dark: rgba(100, 100, 100, 0.2);
            --background-color-light: #f0f0f0;
            --text-color-light: #333333;
            --secondary-text-color-light: rgba(0, 0, 0, 0.7);
            --modal-background-light: rgba(220, 220, 220, 0.8);
            --modal-transparent-light: rgba(240, 240, 240, 0.7);
            --search-background-light: rgba(220, 220, 220, 0.5);
            --light-overlay: rgba(220, 220, 220, 0.2);
            --light-transparent: rgba(255, 255, 255, 0.1);
            --glass-border-light: rgba(200, 200, 200, 0.2);
            --background-color: var(--background-color-dark);
            --text-color: var(--text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --modal-background: var(--modal-background-dark);
            --modal-transparent: var(--modal-transparent-dark);
            --search-background: var(--search-background-dark);
            --overlay-color: var(--dark-overlay);
            --transparent-color: var(--dark-transparent);
            --glass-border: var(--glass-border-dark);
        }
        body.light-theme {
            --background-color: var(--background-color-light);
            --text-color: var(--text-color-light);
            --secondary-text-color: var(--secondary-text-color-light);
            --modal-background: var(--modal-background-light);
            --modal-transparent: var(--modal-transparent-light);
            --search-background: var(--search-background-light);
            --overlay-color: var(--light-overlay);
            --transparent-color: var(--light-transparent);
            --glass-border: var(--glass-border-light);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background-color: var(--background-color);
            min-height: 100vh;
            display: flex;
            user-select: none;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s, background-image 0.5s;
            color: var(--text-color);
        }
        .toolbar {
            display: flex;
            justify-content: center;
            align-content: center;
            flex-direction: row;
            gap: 12px;
            padding: 15px 20px;
            background-color: transparent;
            border: none;
            position: fixed;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            transition: top 0.3s ease;
            width: 100%;
            flex-wrap: wrap;
            height: 80px;
        }
        .toolbar.hidden { top: -100px; opacity: 0; }
        .toolbar.hidden .album-art { margin-top: 0px !IMPORTANT; }
        .toolbar::before { content: ""; position: absolute; inset: 0; z-index: -1; }
        .toolbar::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            backdrop-filter: blur(2.5px);
            mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 1) 50%, rgba(0, 0, 0, 0) 100%);
            -webkit-mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 1) 50%, rgba(0, 0, 0, 0) 100%);
        }
        .tab-btn {
            background-color: var(--search-background);
            color: transparent;
            border-radius: 35px;
            padding: 12px 16px;
            font-size: 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(.3, 1.2, .64, 1) ! IMPORTANT;
            display: flex;
            align-items: center;
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            box-shadow: var(--sun-shadow);
            border: 1px solid var(--glass-border);
        }
        .tab-btn.active {
            background-color: var(--secondary-text-color);
            color: var(--background-color);
            border-radius: 35px;
            corner-shape: superellipse(1.5);
            font-family: 'Open Runde';
            font-weight: 500;
            padding: 10px 18px 10px 16px;
            font-size: revert;
            gap: 12px;
        }
        .toolbar .tab-btn .material-symbols-rounded {
            transition: color 0.3s;
            color: var(--text-color);
            font-size: 20px;
        }
        .toolbar .tab-btn.active .material-symbols-rounded { color: var(--background-color) !important; }
        .view-container {
            flex-grow: 1;
            width: 100%;
            padding: 80px 20px 0 20px;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }
        .view-container::-webkit-scrollbar { width: 8px; }
        .view-container::-webkit-scrollbar-track { background: transparent; }
        .view-container::-webkit-scrollbar-thumb { background-color: var(--search-background); border-radius: 50px; }
        .item-card-title { font-weight: 500; font-family: 'Open Runde'; }
        .item-card-subtitle { font-size: 14px; color: var(--secondary-text-color); }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; }
        .library-search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 25px;
            border: 1px solid var(--glass-border);
            background: var(--search-background);
            color: var(--text-color);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            box-shadow: var(--sun-shadow);
            font-size: 14px;
            outline: none;
        }
        .search-icon {
            font-size: 22px;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-text-color);
            pointer-events: none;
        }
        .filter-container { display: flex; gap: 10px; }
        .filter-btn, .filter-btn-sc {
            padding: 8px 16px;
            height: 42px;
            border-radius: 10px;
        }
        .filter-btn.active, .filter-btn-sc.active {
            background: var(--secondary-text-color);
            color: var(--background-color);
            border-radius: 25px !important;
            font-family: 'Open Runde';
            font-weight: 500;
        }
        .action-btn {
            background-color: var(--search-background);
            color: var(--text-color);
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 42px;
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            box-shadow: var(--sun-shadow);
            border: 1px solid var(--glass-border);
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: var(--overlay-color);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .music-title {
            font-size: 1.3rem;
            word-wrap: break-word;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            font-family: 'Open Runde';
        }
        .search-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 25px;
            border: 1px solid var(--glass-border);
            background: var(--search-background);
            color: var(--text-color);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            box-shadow: var(--sun-shadow);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            flex-grow: 1;
        }
        .search-input:focus { border-color: var(--modal-background); }
        .search-input::placeholder { color: var(--secondary-text-color); }
        .search-icon {
            font-size: 20px;
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-text-color);
            pointer-events: none;
            z-index: 1;
        }
        .filter-btn, .filter-btn-sc {
            flex: 1;
            padding: 8px 10px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            background: var(--search-background);
            color: var(--secondary-text-color);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            box-shadow: var(--sun-shadow);
        }
        .filter-btn.active, .filter-btn-sc.active {
            background: var(--secondary-text-color);
            color: var(--background-color);
        }
        .material-symbols-rounded {
          font-variation-settings: 'FILL' 1, 'wght' 700, 'GRAD' 0, 'opsz' 24;
          vertical-align: middle;
        }
        [onclick], button, a, input[type="button"], input[type="submit"], .clickable {
          cursor: pointer;
          transform: scale(1);
          transition: all 0.15s cubic-bezier(0.2, 0, 0.38, 0.9);
        }
        [onclick]:active, button:active, a:active, input[type="button"]:active, input[type="submit"]:active, .clickable:active {
          transform: scale(0.96);
          transition: all 0.1s cubic-bezier(0.2, 0, 0.38, 0.9);
          filter: brightness(1.5);
        }
        .context-menu {
            position: absolute;
            background-color: var(--search-background);
            border-radius: 35px;
            corner-shape: superellipse(1.5);
            padding: 8px;
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            border: 1px solid var(--glass-border);
            z-index: 10001;
            width: auto;
            box-shadow: var(--sun-shadow), 0 4px 20px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(10px) scale(0.95) scaleY(0.9);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: top;
            margin: 10px;
        }
        .context-menu.visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .menu-item .material-symbols-rounded { font-size: 20px; }
        .menu-separator { height: 1px; background-color: var(--glass-border); margin: 8px 0; }
        .drawer {
            position: fixed;
            bottom: -100%; /* Initially hidden */
            left: 0;
            width: 100%;
            background-color: var(--search-background);
            z-index: 1002;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(5px);
            box-shadow: var(--sun-shadow);
            border-top: 1px solid var(--glass-border);
            border-radius: 50px 50px 0 0;
            corner-shape: superellipse(1.5);
            transform-origin: bottom;
            will-change: transform, opacity, bottom;
            transition: all 0.3s cubic-bezier(.3,1.2,.64,1);
            max-height: calc(100% - 80px);
        }
        .drawer.open { bottom: 0; }
        .drawer-handle {
            width: 50px;
            height: 5px;
            background-color: var(--secondary-text-color);
            border-radius: 3px;
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            cursor: grab;
        }
        .drawer-content {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            user-select: none;
            padding: 20px 20px 140px 20px;
        }
        .drawer-content::-webkit-scrollbar { width: 4px; }
        .drawer-content::-webkit-scrollbar-track { background: transparent; }
        .drawer-content::-webkit-scrollbar-thumb { background: var(--modal-transparent); border-radius: 4px; }
        .drawer-header { padding: 40px 20px 10px 20px; text-align: center; }
        #drawer-title { font-size: 1.5rem; }
        #drawer-subtitle { color: var(--secondary-text-color); }
        @media (min-width: 600px) { .drawer { left: 5vw !important; width: 90vw !important; border: 1px solid var(--glass-border); } }
        @media (min-width: 800px) { .drawer { left: 15vw !important; width: 70vw !important; border: 1px solid var(--glass-border); } }
        @media (min-width: 1000px) { .drawer { left: 25vw !important; width: 50vw !important; border: 1px solid var(--glass-border); } }
        
        /* --- MAP-SPECIFIC OVERRIDES & ADDITIONS --- */
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        /* Hide default attribution, we will add our own */
        .maplibregl-ctrl-bottom-right, .maplibregl-ctrl-bottom-left {
            display: none;
        }
        /* Position nav controls below top UI */
        .maplibregl-ctrl-top-right {
             margin-top: 150px;
        }
        .attribution-footer {
            position: fixed;
            bottom: 16;
            right: 12px;
            z-index: 10;
            background-color: rgba(0,0,0,0.5);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: auto;
        }
        .attribution-footer a {
            color: #bde0ff;
            text-decoration: none;
        }
        .ui-overlay {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows map interaction by default */
        }
        .ui-overlay > * {
            pointer-events: auto; /* Re-enable pointer events for UI elements */
        }
        .panel-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 500px;
            z-index: 1003;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            border-radius: 35px;
            corner-shape: superellipse(1.5);
            border: 1px solid var(--glass-border);
            background: var(--search-background);
            backdrop-filter: var(--edge-refraction-filter) saturate(2) blur(2.5px);
            box-shadow: var(--sun-shadow), 0 0 50px rgba(0, 0, 0, 0.2);
        }
        .directions-input-group {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .directions-input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 25px;
            corner-shape: superellipse(1.5);
            border: 1px solid var(--glass-border);
            background: var(--dark-transparent); /* Use a slightly different bg */
            color: var(--text-color);
            font-size: 14px;
            outline: none;
        }
        .directions-input-group .material-symbols-rounded {
            position: absolute;
            left: 12px;
            color: var(--secondary-text-color);
        }
        .location-btn {
            background: none;
            border: none;
            color: var(--text-color);
        }
        .travel-mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 8px;
        }
        .travel-mode-btn {
            background-color: var(--dark-transparent);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            border-radius: 25px;
            padding: 6px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .travel-mode-btn.active {
            background-color: var(--secondary-text-color);
            color: var(--background-color);
        }
    </style>
</head>
<body data-app-name="MAPS">

    <svg style="display: none">
        <filter id="edge-refraction-only" color-interpolation-filters="linearRGB">
            <!-- Part 1: Create the turbulence noise that will displace the pixels -->
            <feTurbulence type="fractalNoise" baseFrequency="0.01 0.04" numOctaves="2" result="turbulence"></feTurbulence>
        
            <!-- Part 2: Create a mask that is only opaque at the very edges of the source graphic -->
            <feMorphology in="SourceGraphic" operator="erode" radius="4" result="eroded"></feMorphology>
            <feComposite in="SourceGraphic" in2="eroded" operator="out" result="border_mask"></feComposite>
        
            <!-- Part 3: Apply the turbulence only to the edge mask -->
            <feComposite in="turbulence" in2="border_mask" operator="in" result="edge_turbulence"></feComposite>
        
            <!-- Part 4: Create the full edge refraction effect -->
            <!-- Pass 1: A positive scale refracts the top and left edges. -->
            <feDisplacementMap result="disp_positive" yChannelSelector="G" xChannelSelector="R" scale="10" in2="edge_turbulence" in="SourceGraphic"></feDisplacementMap>
            <!-- Pass 2: A negative scale refracts the bottom and right edges. -->
            <feDisplacementMap in="SourceGraphic" in2="edge_turbulence" scale="-10" xChannelSelector="R" yChannelSelector="G" result="disp_negative"></feDisplacementMap>
            <!-- Blend the two passes to get the complete refraction effect. -->
            <feBlend in="disp_positive" in2="disp_negative" mode="lighten" result="refraction_effect"></feBlend>
    
            <!-- Part 5: Create the non-displaced center graphic -->
            <feDisplacementMap in="SourceGraphic" in2="edge_turbulence" scale="0" xChannelSelector="R" yChannelSelector="G" result="centered_graphic"></feDisplacementMap>
            
            <!-- Part 6: Create a mask for the center, leaving a 20px border -->
            <!-- Start with a solid rectangle -->
            <feFlood flood-color="white" result="full_rect"></feFlood>
            <!-- Erode it by 20px to create the inset center mask -->
            <feMorphology in="full_rect" operator="erode" radius="10" result="center_mask"></feMorphology>
            
            <!-- Part 7: Combine the two effects using the mask -->
            <!-- Keep the refracted effect only where it is *outside* the center mask (i.e., the border) -->
            <feComposite in="refraction_effect" in2="center_mask" operator="out" result="border_part"></feComposite>
            <!-- Keep the centered graphic only where it is *inside* the center mask -->
            <feComposite result="center_part" operator="in" in2="center_mask" in="centered_graphic"></feComposite>
            
            <!-- Part 8: Merge the final border and center parts together -->
            <feMerge result="final_image">
                <feMergeNode in="border_part"></feMergeNode>
                <feMergeNode in="center_part"></feMergeNode>
            </feMerge>
    
            <!-- Part 9: Adjust final opacity -->
            <feComponentTransfer in="final_image" result="final_output">
                <feFuncA type="linear" slope="0.95"></feFuncA>
            </feComponentTransfer>
        </filter>
    </svg>

    <div id="map-container"></div>

    <div class="ui-overlay">
        <div class="toolbar">
            <button class="tab-btn active" id="explore-btn"><span class="material-symbols-rounded">map</span>Explore</button>
            <button class="tab-btn" id="directions-btn"><span class="material-symbols-rounded">directions</span>Directions</button>
            <button class="tab-btn" id="game-btn"><span class="material-symbols-rounded">public</span>Game</button>
        </div>

        <div class="panel-container" id="explore-panel">
            <div class="search-container" style="position: relative; top: 0; left: 0; transform: none; width: 100%; max-width: none;">
                <span class="material-symbols-rounded search-icon">search</span>
                <input type="text" id="search-input" placeholder="Search for a place or address" class="library-search-input" style="background-color: transparent; backdrop-filter: none; border: none; box-shadow: none;">
            </div>
        </div>

        <div class="panel-container" id="directions-panel" style="display: none;">
            <div class="directions-input-group">
                <span class="material-symbols-rounded">trip_origin</span>
                <input type="text" id="start-input" class="directions-input" placeholder="Starting point">
                <button id="get-location-btn" class="location-btn"><span class="material-symbols-rounded">my_location</span></button>
            </div>
            <div class="directions-input-group">
                <span class="material-symbols-rounded">location_on</span>
                <input type="text" id="end-input" class="directions-input" placeholder="Choose destination">
            </div>
            <div class="travel-mode-selector">
                <button class="travel-mode-btn active" data-mode="driving-car"><span class="material-symbols-rounded">directions_car</span>Drive</button>
                <button class="travel-mode-btn" data-mode="foot-walking"><span class="material-symbols-rounded">directions_walk</span>Walk</button>
                <button class="travel-mode-btn" data-mode="cycling-road"><span class="material-symbols-rounded">directions_bike</span>Cycle</button>
            </div>
        </div>

        <div class="attribution-footer">
            <a href="https://openfreemap.org/" target="_blank">OpenFreeMap</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>
        </div>

        <div id="drawer" class="drawer">
            <div class="drawer-handle"></div>
            <div class="drawer-header"><h2 id="drawer-title"></h2><p id="drawer-subtitle"></p></div>
            <div class="drawer-content" id="drawer-content"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- IMPORTANT: ADD YOUR API KEY HERE ---
            const OPENROUTESERVICE_API_KEY = 'YOUR_API_KEY_HERE'; 
            // ---

            let map;
            let searchMarker, startMarker, endMarker;
            let startCoords, endCoords;

            map = new maplibregl.Map({
                container: 'map-container',
                style: 'https://tiles.openfreemap.org/styles/liberty',
                center: [2.3522, 48.8566],
                zoom: 11,
            });

            map.on('load', () => {
                // Add a source and layer for drawing the route
                map.addSource('route', { type: 'geojson', data: null });
                map.addLayer({
                    id: 'route-layer',
                    type: 'line',
                    source: 'route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#45b7d1', 'line-width': 6, 'line-opacity': 0.8 }
                });
            });

            map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');
            
            const exploreBtn = document.getElementById('explore-btn');
            const directionsBtn = document.getElementById('directions-btn');
            const gameBtn = document.getElementById('game-btn');
            const explorePanel = document.getElementById('explore-panel');
            const directionsPanel = document.getElementById('directions-panel');

            function setActiveButton(activeBtn) {
                [exploreBtn, directionsBtn, gameBtn].forEach(btn => btn.classList.remove('active'));
                activeBtn.classList.add('active');
                
                explorePanel.style.display = 'none';
                directionsPanel.style.display = 'none';

                if (activeBtn === exploreBtn) explorePanel.style.display = 'flex';
                if (activeBtn === directionsBtn) directionsPanel.style.display = 'flex';
                clearMap();
            }

            exploreBtn.addEventListener('click', () => setActiveButton(exploreBtn));
            directionsBtn.addEventListener('click', () => setActiveButton(directionsBtn));
            gameBtn.addEventListener('click', () => {
                setActiveButton(gameBtn);
                Gurasuraisu.showPopup('Game mode is coming soon!');
            });
            
            // --- Generic Search Function ---
            const performSearch = async (query) => {
                const endpoint = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10`;
                try {
                    const response = await fetch(endpoint, { headers: { 'User-Agent': 'GurasuraisuMaps/1.0' } });
                    if (!response.ok) throw new Error('Network error');
                    return await response.json();
                } catch (error) {
                    console.error('Search failed:', error);
                    Gurasuraisu.showPopup('Could not perform search.');
                    return [];
                }
            };
            
            const displaySearchResults = (results, onResultClick) => {
                let contentHtml;
                if (results.length === 0) {
                    contentHtml = '<p style="text-align: center; color: var(--secondary-text-color);">No results found.</p>';
                } else {
                    const getResultParts = (displayName) => ({ title: displayName.split(', ')[0], subtitle: displayName.split(', ').slice(1).join(', ') });
                    contentHtml = results.map(result => `
                        <div class="menu-item clickable" data-lat="${result.lat}" data-lon="${result.lon}" data-name="${result.display_name.split(',')[0]}">
                            <span class="material-symbols-rounded">location_on</span>
                            <div class="menu-item-info">
                                <div class="menu-item-title">${getResultParts(result.display_name).title}</div>
                                <div class="menu-item-subtitle">${getResultParts(result.display_name).subtitle}</div>
                            </div>
                        </div>`).join('');
                }
                openDrawer('Search Results', '', contentHtml, onResultClick);
            };

            // --- Explore View Logic ---
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    const query = searchInput.value.trim();
                    if (query.length < 3) {
                        closeDrawer();
                        return;
                    }
                    const results = await performSearch(query);
                    displaySearchResults(results, (item) => {
                        const lat = parseFloat(item.dataset.lat);
                        const lon = parseFloat(item.dataset.lon);
                        if (searchMarker) searchMarker.remove();
                        searchMarker = new maplibregl.Marker({ color: '#ff6b6b' }).setLngLat([lon, lat]).addTo(map);
                        map.flyTo({ center: [lon, lat], zoom: 15, speed: 1.5 });
                        closeDrawer(); // Auto-close on selection
                    });
                }, 500);
            });
            
            // --- Directions View Logic ---
            const startInput = document.getElementById('start-input');
            const endInput = document.getElementById('end-input');
            
            [startInput, endInput].forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(async () => {
                        const query = input.value.trim();
                        if (query.length < 3) return;
                        const results = await performSearch(query);
                        displaySearchResults(results, (item) => {
                            const lat = parseFloat(item.dataset.lat);
                            const lon = parseFloat(item.dataset.lon);
                            const name = item.dataset.name;
                            input.value = name;
                            if(input.id === 'start-input') startCoords = [lon, lat];
                            else endCoords = [lon, lat];
                            
                            if (startCoords && endCoords) getRoute();
                            closeDrawer(); // Auto-close on selection
                        });
                    }, 500);
                });
            });

            document.getElementById('get-location-btn').addEventListener('click', () => {
                if (!navigator.geolocation) return Gurasuraisu.showPopup('Geolocation is not supported.');
                navigator.geolocation.getCurrentPosition(pos => {
                    startCoords = [pos.coords.longitude, pos.coords.latitude];
                    startInput.value = 'My Current Location';
                    if (startMarker) startMarker.remove();
                    startMarker = new maplibregl.Marker({ color: '#4ecdc4' }).setLngLat(startCoords).addTo(map);
                    map.flyTo({ center: startCoords, zoom: 15 });
                    if(endCoords) getRoute();
                }, () => Gurasuraisu.showPopup('Unable to retrieve your location.'));
            });

            document.querySelectorAll('.travel-mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.travel-mode-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    if (startCoords && endCoords) getRoute();
                });
            });

            async function getRoute() {
                if (OPENROUTESERVICE_API_KEY === 'YOUR_API_KEY_HERE' || !OPENROUTESERVICE_API_KEY) {
                    return Gurasuraisu.showPopup('API key is missing for directions.');
                }
                const travelMode = document.querySelector('.travel-mode-btn.active').dataset.mode;
                const url = `https://api.openrouteservice.org/v2/directions/${travelMode}?api_key=${OPENROUTESERVICE_API_KEY}&start=${startCoords.join(',')}&end=${endCoords.join(',')}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);

                    const routeGeoJSON = data.features[0];
                    map.getSource('route').setData(routeGeoJSON);
                    
                    if (startMarker) startMarker.remove();
                    startMarker = new maplibregl.Marker({ color: '#4ecdc4' }).setLngLat(startCoords).addTo(map);
                    if (endMarker) endMarker.remove();
                    endMarker = new maplibregl.Marker({ color: '#ff6b6b' }).setLngLat(endCoords).addTo(map);

                    const bounds = new maplibregl.LngLatBounds(startCoords, endCoords);
                    routeGeoJSON.geometry.coordinates.forEach(coord => bounds.extend(coord));
                    map.fitBounds(bounds, { padding: 80, duration: 1000 });

                    displayRouteSteps(data.features[0].properties.segments[0].steps, data.features[0].properties.summary);
                } catch (error) {
                    Gurasuraisu.showPopup(`Could not get route: ${error.message}`);
                    console.error("Routing error:", error);
                }
            }
            
            function displayRouteSteps(steps, summary) {
                const duration = Math.round(summary.duration / 60);
                const distance = (summary.distance / 1000).toFixed(1);

                const stepsHtml = steps.map(step => `
                    <div class="menu-item">
                        <span class="material-symbols-rounded">turn_right</span> <!-- Icon needs to be dynamic later -->
                        <div class="menu-item-info">
                            <div class="menu-item-title">${step.instruction}</div>
                            <div class="menu-item-subtitle">${step.distance.toFixed(0)} meters</div>
                        </div>
                    </div>
                `).join('');
                
                openDrawer(`Route (${duration} min)`, `${distance} km`, stepsHtml);
            }

            // --- Drawer Management ---
            const drawer = document.getElementById('drawer');
            const drawerOverlay = document.getElementById('drawer-overlay');
            const drawerHeader = document.querySelector('.drawer-header');
            let isDrawerOpen = false;

            function openDrawer(title, subtitle, contentHtml, onItemClick) {
                document.getElementById('drawer-title').textContent = title;
                document.getElementById('drawer-subtitle').textContent = subtitle;
                const drawerContent = document.getElementById('drawer-content');
                drawerContent.innerHTML = contentHtml;
                
                if (onItemClick) {
                    drawerContent.querySelectorAll('.clickable').forEach(item => {
                        item.addEventListener('click', () => onItemClick(item));
                    });
                }

                if (!isDrawerOpen) {
                    drawer.classList.add('open');
                    drawerOverlay.classList.add('visible');
                    isDrawerOpen = true;
                }
            }

            function closeDrawer() {
                if (!isDrawerOpen) return;
                drawer.classList.remove('open');
                drawerOverlay.classList.remove('visible');
                isDrawerOpen = false;
            }
            
            function clearMap() {
                 if(searchMarker) searchMarker.remove();
                 if(startMarker) startMarker.remove();
                 if(endMarker) endMarker.remove();
                 if(map.getSource('route')) map.getSource('route').setData({type: 'FeatureCollection', features: []});
                 startCoords = null; endCoords = null;
                 startInput.value = ''; endInput.value = '';
                 closeDrawer();
            }

            // --- UPDATED: Event listeners to close the drawer ---
            drawerOverlay.addEventListener('click', closeDrawer);
            drawerHeader.addEventListener('click', closeDrawer);
        });
    </script>
</body>
</html>
