<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waves (Beta)</title>
    <link id="favicon" rel="icon" type="image/png" href="favicon.png">
    <meta name="theme-color" content="#141218">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script type="module">
        import { joinRoom, selfId } from 'https://esm.sh/trystero@0.15.1/torrent';
        window.Trystero = { joinRoom, selfId };
        window.dispatchEvent(new Event('trystero-ready'));
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">

    <style>
        /* MD3 Token-ish Variables */
        :root {
            --md-sys-color-background: #141218;
            --md-sys-color-on-background: #E6E1E5;
            --md-sys-color-surface: #1D1B20;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            
            --border-radius-lg: 28px;
            --border-radius-md: 16px;
            --border-radius-sm: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* State Views */
        .view { display: none; height: 100%; width: 100%; max-width: 800px; margin: auto; flex-direction: column; padding: 16px; overflow-y: auto; }
        .view.active { display: flex; }

        /* Typography */
        h1 { font-size: 32px; margin: 0 0 16px 0; font-weight: 400; }
        h2 { font-size: 22px; margin: 24px 0 12px 0; font-weight: 400; color: var(--md-sys-color-on-surface); }
        .label-large { font-size: 14px; font-weight: 500; line-height: 20px; }
        .label-medium { font-size: 12px; font-weight: 500; letter-spacing: 0.5px; }

        .code-input {
            background: #49454F;
            border: 1px solid #938F99;
            border-radius: 8px;
            color: white;
            font-family: monospace;
            font-size: 24px;
            text-align: center;
            padding: 16px;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin: 20px 0;
        }

        /* Emoji Grid */
        .emoji-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        .emoji-btn {
            background: #49454F;
            border: none;
            border-radius: 16px;
            font-size: 48px;
            padding: 20px;
            cursor: pointer;
        }
        .emoji-btn:active { background: #D0BCFF; }

        /* Components */
        .card {
            background: var(--md-sys-color-surface);
            border-radius: var(--border-radius-lg);
            padding: 16px;
            margin-bottom: 12px;
        }

        .filled-card {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
            border-radius: var(--border-radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 100px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 16px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface-variant);
            padding: 8px;
            border-radius: 50%;
        }
        .icon-btn:active { background: rgba(255,255,255,0.1); }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: none;
        }

        /* Setup View */
        .setup-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* Dashboard View */
        .top-app-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #FF5449;
        }
        .status-dot.connected { background: #B6F2AF; }

        /* Media Player */
        .media-player {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 28px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 16px;
        }
        .album-art {
            width: 120px; height: 120px;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .track-info h3 { margin: 0; font-size: 20px; }
        .track-info p { margin: 4px 0 0 0; opacity: 0.8; font-size: 14px; }
        .media-controls {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        .play-pause {
            background: var(--md-sys-color-on-primary-container);
            color: var(--md-sys-color-primary-container);
            width: 64px; height: 64px;
            border-radius: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none;
        }
        
        /* Quick Actions Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .action-card {
            background: var(--md-sys-color-surface-variant);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--md-sys-color-on-surface);
            border: none;
        }
        .action-card:active { background: #5f5b66; }

        /* Brightness Slider */
        .slider-container {
            background: var(--md-sys-color-surface-variant);
            border-radius: 100px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
        }
        input[type=range] {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 20px; height: 20px;
            background: var(--md-sys-color-primary);
            border-radius: 50%;
        }

        /* App Drawer */
        .app-drawer-sheet {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--md-sys-color-surface);
            border-radius: 28px 28px 0 0;
            padding: 24px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 100;
        }
        .app-drawer-sheet.open { transform: translateY(0); }
        
        .app-list-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .app-list-item img { width: 40px; height: 40px; border-radius: 12px; }

        .screenshot-modal {
            position: fixed; inset: 0;
            background: #000;
            display: none;
            align-items: center; justify-content: center;
            z-index: 200;
        }
        .screenshot-modal.open { display: flex; }
        .screenshot-modal img { max-width: 100%; max-height: 100%; }
        .screenshot-modal button {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.2);
            color: white; border: none; padding: 8px; border-radius: 50%;
        }

    </style>
</head>
<body>

    <!-- SETUP VIEW -->
    <div id="view-setup" class="view active">
        <div class="setup-content">
            <span class="material-symbols-rounded" style="font-size: 64px; color: var(--md-sys-color-primary);">cell_tower</span>
            <h1 style="margin-top:16px;">Waves (Beta)</h1>
            <p style="opacity: 0.7;">Control your Polygol display</p>
            <p style="opacity: 0.7;">Open Settings > Connections > Show Code to start pairing</p>
            <p style="opacity: 0.7; text-align:center;">Enter the code shown on the Display</p>
            
            <input type="text" id="input-code" class="code-input" placeholder="ABC-123" maxlength="7">
            
            <button class="btn-primary" id="btn-connect" style="margin-top:0;">
                Connect
            </button>
        </div>
    </div>

    <!-- 2. VERIFICATION VIEW -->
    <div id="view-auth" class="view">
        <div class="setup-content">
            <h2>Verification</h2>
            <p style="opacity: 0.7; text-align:center;">Tap the emoji shown on the Display</p>
            <div id="emoji-container" class="emoji-grid"></div>
        </div>
    </div>

    <!-- REMOTE DASHBOARD VIEW -->
    <div id="view-remote" class="view">
        <div class="top-app-bar">
            <div class="connection-status">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">Connecting...</span>
            </div>
            <button class="icon-btn" onclick="disconnect()">
                <span class="material-symbols-rounded">logout</span>
            </button>
        </div>

        <!-- Media Player -->
        <div class="media-player">
            <img id="media-art" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="album-art">
            <div class="track-info">
                <h3 id="media-title">No Media</h3>
                <p id="media-artist">Not Playing</p>
            </div>
            <div class="media-controls">
                <button class="icon-btn" onclick="sendMedia('prev')"><span class="material-symbols-rounded" style="font-size: 32px;">skip_previous</span></button>
                <button class="play-pause" onclick="sendMedia('playPause')"><span class="material-symbols-rounded" style="font-size: 36px;">play_arrow</span></button>
                <button class="icon-btn" onclick="sendMedia('next')"><span class="material-symbols-rounded" style="font-size: 32px;">skip_next</span></button>
            </div>
        </div>

        <h2>Controls</h2>
        <div class="grid-2">
            <button class="action-card" onclick="sendCommand('toggleSleep')">
                <span class="material-symbols-rounded" style="font-size: 32px;">power_settings_new</span>
                <span class="label-large">Power</span>
            </button>
            <button class="action-card" onclick="sendCommand('home')">
                <span class="material-symbols-rounded" style="font-size: 32px;">home</span>
                <span class="label-large">Home</span>
            </button>
             <button class="action-card" onclick="requestScreenshot()">
                <span class="material-symbols-rounded" style="font-size: 32px;">screenshot_monitor</span>
                <span class="label-large">View</span>
            </button>
             <button class="action-card" onclick="toggleAppDrawer()">
                <span class="material-symbols-rounded" style="font-size: 32px;">apps</span>
                <span class="label-large">Apps</span>
            </button>
        </div>

        <h2>Brightness</h2>
        <div class="slider-container">
            <span class="material-symbols-rounded">brightness_5</span>
            <input type="range" id="remote-brightness" min="20" max="100" onchange="sendCommand('setBrightness', this.value)">
        </div>
    </div>

    <!-- App Drawer Sheet -->
    <div id="app-drawer-sheet" class="app-drawer-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
            <h2>Applications</h2>
            <button class="icon-btn" onclick="toggleAppDrawer()"><span class="material-symbols-rounded">close</span></button>
        </div>
        <div id="app-list-container"></div>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshot-view" class="screenshot-modal">
        <button onclick="this.parentElement.classList.remove('open')"><span class="material-symbols-rounded">close</span></button>
        <img id="screenshot-img" src="">
    </div>

    <script>
        // Manually set the worker path to the CDN URL to prevent CORS/resolution errors
        if (typeof QrScanner !== 'undefined') {
            QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';
        }
        
        const CONFIG = { appId: 'polygol-connect-v1' };
        let room, sendAction;
        let currentConfig = null;

        // --- UI Helpers ---
        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        function setStatus(connected) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if (!dot || !text) return;
            if (connected) {
                dot.classList.add('connected');
                text.innerText = "Connected";
                // Request initial state once connected
                sendCommand('getApps');
                sendCommand('requestScreenshot');
            } else {
                dot.classList.remove('connected');
                text.innerText = "Disconnected";
            }
        }

        function toggleAppDrawer() {
            document.getElementById('app-drawer-sheet').classList.toggle('open');
        }

        function updateMediaUI(metadata, playbackState) {
            if (!metadata) return;
            
            // Update Text
            document.getElementById('media-title').innerText = metadata.title || "Unknown";
            document.getElementById('media-artist').innerText = metadata.artist || "Unknown";
            
            // Update Artwork
            const artImg = document.getElementById('media-art');
            let artSrc = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            if (metadata.artwork && metadata.artwork.length > 0) {
                artSrc = metadata.artwork[0].src;
            }
            artImg.src = artSrc;
    
            // Update Play/Pause Button Icon
            const playBtnIcon = document.querySelector('.play-pause span');
            if (playbackState === 'playing') {
                playBtnIcon.innerText = 'pause';
            } else {
                playBtnIcon.innerText = 'play_arrow';
            }
    
            // --- Native Media Session API (Lock Screen Controls) ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: metadata.title || "Polygol Media",
                    artist: metadata.artist || "Remote Control",
                    artwork: [
                        { src: artSrc, sizes: '512x512', type: 'image/png' }
                    ]
                });
    
                // Update playback state for OS
                navigator.mediaSession.playbackState = playbackState || 'none';
    
                // Bind handlers (only need to do this once, but doing it here ensures data availability)
                navigator.mediaSession.setActionHandler('play', () => sendMedia('playPause'));
                navigator.mediaSession.setActionHandler('pause', () => sendMedia('playPause'));
                navigator.mediaSession.setActionHandler('previoustrack', () => sendMedia('prev'));
                navigator.mediaSession.setActionHandler('nexttrack', () => sendMedia('next'));
            }
        }

        function updateBrightnessUI(value) {
            const slider = document.getElementById('remote-brightness');
            if(slider) slider.value = value;
        }
        
        function renderAppList(apps) {
            const container = document.getElementById('app-list-container');
            container.innerHTML = '';
            
            if(!apps || apps.length === 0) {
                container.innerHTML = '<p style="text-align:center; opacity:0.5; padding:20px;">No apps found on host.</p>';
                return;
            }

            apps.forEach(app => {
                const div = document.createElement('div');
                div.className = 'app-list-item';
                div.onclick = () => {
                    sendCommand('launchApp', { url: app.url });
                    toggleAppDrawer(); 
                };
                
                const imgHtml = app.icon 
                    ? `<img src="${app.icon}" onerror="this.style.display='none'">` 
                    : '<span class="material-symbols-rounded" style="font-size:32px; opacity:0.7;">apps</span>';

                div.innerHTML = `
                    ${imgHtml}
                    <span style="font-size:16px; font-weight:500;">${app.name}</span>
                `;
                container.appendChild(div);
            });
        }

        // --- Networking ---
        function connect(config) {
            if (!window.Trystero) {
                // Wait for library
                window.addEventListener('trystero-ready', () => connect(config), { once: true });
                return;
            }

            // Case 1: We have a PSK (Restoring session)
            if (config.k) {
                startRemoteSession(config);
            } 
            // Case 2: No PSK (New connection handshake)
            else {
                startHandshake(config.r);
            }
        }

        // 1. New Connection Handshake
        function startHandshake(roomId) {
            console.log("Starting handshake for room:", roomId);
            room = window.Trystero.joinRoom(CONFIG, roomId);
            const [send, get] = room.makeAction('waves-cmd');
            
            // Handle Auth Messages
            get((payload, peerId) => {
                if (payload.type === 'challenge') {
                    renderEmojiGrid(payload.options, peerId, send);
                    showView('view-auth');
                } 
                else if (payload.type === 'authorized') {
                    // Auth Success! Save keys and switch to remote view
                    const newConfig = { r: roomId, k: payload.psk };
                    localStorage.setItem('waves_client_config', JSON.stringify(newConfig));
                    
                    // Cleanup handshake listeners and start full session
                    room.leave(); 
                    setTimeout(() => startRemoteSession(newConfig), 500);
                } 
                else if (payload.type === 'auth_failed') {
                    alert("Incorrect Emoji. Connection refused.");
                    window.location.reload();
                }
            });

            // Send Hello when we find the host
            room.onPeerJoin(peerId => {
                console.log("Host found, saying hello...");
                send({ type: 'hello' }, peerId);
            });
        }

        // 2. Authenticated Session (The actual remote control)
        function startRemoteSession(config) {
            currentConfig = config;
            showView('view-remote');

            console.log("Starting secure session...");
            room = window.Trystero.joinRoom(CONFIG, config.r);
            
            // Setup Channels
            const [sendCmd, getCmd] = room.makeAction('waves-cmd');
            sendAction = sendCmd;
            const [sendUpd, getUpd] = room.makeAction('waves-update');
            
            // Listen for State Updates (Media, Brightness)
            getUpd((payload) => {
                if (payload.type === 'mediaUpdate') {
                    updateMediaUI(payload.data.metadata, payload.data.playbackState);
                } else if (payload.type === 'state') {
                    updateBrightnessUI(payload.data.brightness);
                    if(payload.data.media) {
                        updateMediaUI(payload.data.media, payload.data.mediaState);
                    }
                }
            });
            
            // Listen for Data Responses (Screenshots, App Lists)
            getCmd((payload) => {
                if (payload.type === 'screenshot') {
                    const modalImg = document.getElementById('screenshot-img');
                    if(modalImg) {
                        modalImg.src = payload.data;
                        document.getElementById('screenshot-view').classList.add('open');
                    }
                } else if (payload.type === 'appList') {
                    renderAppList(payload.data);
                }
            });

            room.onPeerJoin(() => setStatus(true));
            room.onPeerLeave(() => setStatus(false));
        }

        function renderEmojiGrid(options, peerId, sendFunc) {
            const container = document.getElementById('emoji-container');
            container.innerHTML = '';
            
            options.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.innerText = emoji;
                btn.onclick = () => {
                    // Send Answer
                    sendFunc({ type: 'verify', answer: emoji }, peerId);
                    container.innerHTML = '<p style="grid-column: span 2; text-align: center; color: white;">Verifying...</p>';
                };
                container.appendChild(btn);
            });
        }

        function sendCommand(type, data = null) {
            if(!sendAction) return;
            sendAction({
                auth: currentConfig.k,
                type: type,
                data: data
            });
        }

        function sendMedia(action) {
            // Send the action string directly as data, Host interprets it
            sendCommand('media', { action: action });
        }

        function requestScreenshot() {
            const img = document.getElementById('remote-screen-img');
            if(img) img.style.opacity = '0.5'; // Visual feedback
            sendCommand('requestScreenshot');
        }
        
        function disconnect() {
            localStorage.removeItem('waves_client_config');
            window.location.reload();
        }

        // --- QR Logic ---
        function normalizeConfig(raw) {
            if (!raw) return null;
            if (raw.roomId && raw.psk) return { r: raw.roomId, k: raw.psk };
            if (raw.r && raw.k) return raw;
            return null;
        }
        
        function onScanSuccess(result) {
            if (!isScanning) return;
            
            // qr-scanner returns an object, we want the .data property
            const decodedText = result.data || result;
        
            try {
                const config = normalizeConfig(JSON.parse(decodedText));
                if(config) {
                    isScanning = false;
                    if(qrScanner) {
                        qrScanner.stop();
                        // Optional: Clear video source to release memory
                        const video = document.getElementById('qr-video');
                        if(video) video.srcObject = null;
                    }
                    connect(config);
                }
            } catch(e) {
                // Ignore invalid codes
            }
        }
        
        document.getElementById('input-code').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
        });

        document.getElementById('btn-connect').onclick = () => {
            const code = document.getElementById('input-code').value.trim();
            if (code.length < 3) {
                alert("Please enter a valid code");
                return;
            }
            connect({ r: code });
        };

        // --- Init ---
        const saved = localStorage.getItem('waves_client_config');
        if(saved) {
            try {
                const config = JSON.parse(saved);
                if(config.r && config.k) connect(config);
            } catch(e) {
                console.error("Bad config", e);
            }
        }

        // Auto Connect
        const saved = localStorage.getItem('waves_client_config');
        if(saved) connect(JSON.parse(saved));

    </script>
</body>
</html>
