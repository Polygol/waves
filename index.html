<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waves</title>
    <link id="favicon" rel="icon" type="image/png" href="favicon.png">
    <meta name="theme-color" content="#141218">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <script type="module">
        import { joinRoom, selfId } from 'https://esm.sh/trystero@0.15.1/torrent';
        window.Trystero = { joinRoom, selfId };
        window.dispatchEvent(new Event('trystero-ready'));
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">

    <style>
        /* MD3 Token-ish Variables */
        :root {
            /* Base Hue (Default Purple) */
            --theme-r: 208;
            --theme-g: 188;
            --theme-b: 255;
    
            /* Derived Colors using CSS Calc for mixing */
            --md-sys-color-primary: rgb(var(--theme-r), var(--theme-g), var(--theme-b));
            
            /* Background: Very dark tint of the accent */
            --md-sys-color-background: rgb(
                calc(var(--theme-r) * 0.05 + 10), 
                calc(var(--theme-g) * 0.05 + 10), 
                calc(var(--theme-b) * 0.05 + 10)
            );
    
            /* Surface: Slightly lighter tint */
            --md-sys-color-surface: rgb(
                calc(var(--theme-r) * 0.08 + 25), 
                calc(var(--theme-g) * 0.08 + 25), 
                calc(var(--theme-b) * 0.08 + 25)
            );
    
            /* Surface Variant: Middle tint */
            --md-sys-color-surface-variant: rgb(
                calc(var(--theme-r) * 0.15 + 40), 
                calc(var(--theme-g) * 0.15 + 40), 
                calc(var(--theme-b) * 0.15 + 40)
            );
    
            /* Containers */
            --md-sys-color-primary-container: rgba(var(--theme-r), var(--theme-g), var(--theme-b), 0.3);
            --md-sys-color-on-primary: #ffffff; 
            
            --md-sys-color-secondary-container: rgba(var(--theme-r), var(--theme-g), var(--theme-b), 0.2);
            --md-sys-color-on-secondary-container: #E6E1E5; 
            
            --md-sys-color-on-background: #E6E1E5;
            --md-sys-color-on-surface: #E6E1E5;
            
            --border-radius-lg: 28px;
            --border-radius-md: 16px;
        }

        /* Light Theme Overrides */
        body.light-theme {
            --md-sys-color-background: rgb(
                calc(var(--theme-r) * 0.05 + 240), 
                calc(var(--theme-g) * 0.05 + 240), 
                calc(var(--theme-b) * 0.05 + 240)
            );
            --md-sys-color-on-background: #1C1B1F;
            
            --md-sys-color-surface: rgb(
                calc(var(--theme-r) * 0.08 + 225), 
                calc(var(--theme-g) * 0.08 + 225), 
                calc(var(--theme-b) * 0.08 + 225)
            );
            
            --md-sys-color-surface-variant: rgb(
                calc(var(--theme-r) * 0.1 + 215), 
                calc(var(--theme-g) * 0.1 + 215), 
                calc(var(--theme-b) * 0.1 + 215)
            );
            
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            
            --md-sys-color-secondary-container: rgba(var(--theme-r), var(--theme-g), var(--theme-b), 0.2);
            --md-sys-color-on-secondary-container: #1d1b20; /* Dark text for light mode */
            
            --md-sys-color-on-primary-container: #1d1b20;
        }
        
        /* High Contrast Overrides */
        body.high-contrast {
            --md-sys-color-background: #000 !important;
            --md-sys-color-surface: #000 !important;
            --md-sys-color-surface-variant: #333 !important;
            border: 1px solid #fff;
        }
        body.light-theme.high-contrast {
            --md-sys-color-background: #fff !important;
            --md-sys-color-surface: #fff !important;
            --md-sys-color-surface-variant: #eee !important;
            border: 1px solid #000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* State Views */
        .view { display: none; height: 100%; width: 100%; max-width: 800px; margin: auto; flex-direction: column; padding: 16px 16px 80px 16px; overflow-y: auto; }
        .view.active { display: flex; }

        /* Typography */
        h1 { font-size: 32px; margin: 0 0 16px 0; font-weight: 400; }
        h2 { font-size: 22px; margin: 24px 0 12px 0; font-weight: 400; color: var(--md-sys-color-on-surface); }
        .label-large { font-size: 14px; font-weight: 500; line-height: 20px; }
        .label-medium { font-size: 12px; font-weight: 500; letter-spacing: 0.5px; }

        .code-input {
            background: var(--md-sys-color-surface-variant) !important;
            color: var(--md-sys-color-on-surface) !important;
            border: 1px solid var(--md-sys-color-surface-variant);
            border-radius: 8px;
            font-size: 24px;
            text-align: center;
            padding: 16px;
            width: 100%;
            letter-spacing: 4px;
            margin: 20px 0;
        }

        /* Emoji Grid */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 Columns */
            gap: 12px;
            margin-top: 20px;
        }
        .emoji-btn {
            background: var(--md-sys-color-surface-variant) !important;
            border: none;
            border-radius: 12px;
            font-size: 28px;
            padding: 0;
            aspect-ratio: 1 / 1; /* Keep them square */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emoji-btn:active { background: #D0BCFF; }

        /* Components */
        .card {
            background: var(--md-sys-color-surface);
            border-radius: var(--border-radius-lg);
            padding: 16px;
            margin-bottom: 12px;
        }

        .filled-card {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
            border-radius: var(--border-radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .btn-primary {
            font-family: 'Inter', sans-serif;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 100px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 16px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            gap: 8px;
        }

        .icon-btn {
            font-family: 'Inter', sans-serif;
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface-variant);
            padding: 8px;
            border-radius: 50%;
        }
        .icon-btn:active { background: rgba(255,255,255,0.1); }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: none;
        }

        /* Setup View */
        .setup-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* Dashboard View */
        .top-app-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #FF5449;
        }
        .status-dot.connected { background: #B6F2AF; }

        /* Media Player */
        .media-player {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 28px;
            padding: 12px;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .album-art {
            width: 64px;
            height: 64px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 14px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-right: 10px;
        }
        .track-info { width: 100%; }
        .track-info h3 { margin: 0; font-size: 16px; }
        .track-info p { margin: 4px 0 0 0; opacity: 0.8; font-size: 16px; }
        .media-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .play-pause {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            width: 64px;
            height: 48px;
            border-radius: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none;
        }
        
        /* Quick Actions Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .action-card {
            font-family: 'Inter', sans-serif;
            background: var(--md-sys-color-surface-variant);
            border-radius: 28px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--md-sys-color-on-surface);
            border: none;
        }
        .action-card:active { background: var(--md-sys-color-primary); }

        /* Brightness Slider */
        .slider-container {
            background: var(--md-sys-color-surface-variant);
            border-radius: 100px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
        }
        input[type=range] {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 20px; height: 20px;
            background: var(--md-sys-color-primary);
            border-radius: 50%;
        }
    
        .status-bar-remote {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-group { display: flex; gap: 12px; align-items: center; }
        .status-pill {
            display: flex; align-items: center; gap: 6px;
            padding: 4px 10px;
            color: var(--md-sys-color-on-secondary-container);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Settings Frame */
        .settings-frame-container {
            display: none;
            flex: 1;
            width: 100%;
            background: var(--md-sys-color-background); /* Match theme */
            border-radius: 20px;
            overflow: hidden;
        }
        iframe#settings-frame { width: 100%; height: 100%; border: none; display: block; }

        /* App Drawer */
        .app-drawer-sheet {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--md-sys-color-surface);
            border-radius: 28px 28px 0 0;
            padding: 24px;
            height: 100%;
            overflow-y: auto;
            transform: translateY(100%) translateX(-50%);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 100;
            width: clamp(200px, 100%, 800px);
            left: 50%;
        }
        .app-drawer-sheet.open { transform: translateY(0) translateX(-50%); }
        
        .app-list-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .app-list-item img { width: 40px; height: 40px; border-radius: 50%; }

        .screenshot-modal {
            position: fixed; inset: 0;
            background: #000;
            display: none;
            align-items: center; justify-content: center;
            z-index: 200;
        }
        .screenshot-modal.open { display: flex; }
        .screenshot-modal img { max-width: 100%; max-height: 100%; }
        .screenshot-modal button {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.2);
            color: white; border: none; padding: 8px; border-radius: 50%;
        }
        .loading-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(50, 50, 50, 0.9); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 14px; font-weight: 500;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .loading-toast.show { opacity: 1; }
        .mini-app-pill {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 24px 24px 0 0;
            padding: 16px 24px;
            display: none;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: transform 0.1s;
            position: fixed;
            bottom: 0;
            z-index: 10;
            width: 100%;
            left: 0;
        }
        .mini-app-pill.visible { display: flex; }
        .mini-app-pill:active { transform: scale(0.98); }
        .mini-app-pill img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .mini-app-pill .info { flex: 1; font-weight: 500; font-size: 16px; }
        .mini-app-pill .action-btn { 
            color: var(--md-sys-color-on-primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid var(--md-sys-color-on-primary);
        }
        /* Segmented Control */
        .segment-control {
            display: flex;
            background: var(--md-sys-color-surface-variant);
            border-radius: 50px;
            padding: 4px;
            margin-bottom: 16px;
        }
        .segment-btn {
            flex: 1;
            background: transparent;
            border: none;
            padding: 10px;
            border-radius: 50px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            transition: background 0.2s, color 0.2s, border-radius 0.2s;
        }
        .segment-btn.active {
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* Widget Grid */
        .widget-grid-remote {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        .widget-preview {
            background: var(--md-sys-color-surface-variant);
            overflow: hidden;
            aspect-ratio: 1/1;
            position: relative;
            border-radius: 18%;
            corner-shape: superellipse(1.5);
        }
        .widget-preview img {
            width: 100%; height: 100%; object-fit: contain;
        }

        /* Live Activity Iframe */
        .remote-activity-frame {
            width: 100%;
            border: none;
            border-radius: 20px;
            margin-bottom: 12px;
            background: #000;
            overflow: hidden;
        }

        #remote-wallpaper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            opacity: 0.2;
            transition: background-image 0.5s ease;
        }

        /* Wallpaper Grid */
        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            padding: 16px 0;
        }
        .wallpaper-item {
            aspect-ratio: 1/1;
            border-radius: 24px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 8px solid transparent;
        }
        .wallpaper-item.active {
            border-color: var(--md-sys-color-primary);
        }
        .wallpaper-item img {
            width: 100%; height: 100%; object-fit: cover;
        }
        
        /* QS Buttons */
        .qs-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        .qs-btn {
            background: var(--md-sys-color-primary-container);
            border: none;
            border-radius: 50%; /* Circle */
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-surface);
            font-size: 24px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .qs-btn.active {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 28px;
        }
    </style>
</head>
<body>
    <div id="remote-wallpaper"></div>
    
    <!-- Loading Toast -->
    <div id="loading-toast" class="loading-toast">Loading</div>

    <!-- PROFILE SETUP VIEW -->
    <div id="view-profile-setup" class="view">
        <div class="setup-content">
            <span class="material-symbols-rounded" style="font-size: 64px; color: var(--md-sys-color-primary);">account_circle</span>
            <h1 style="margin-top:16px;">Who are you?</h1>
            <p style="opacity: 0.7;">Create a profile to identify yourself.</p>
            
            <div style="margin: 20px 0; position: relative; width: 100px; height: 100px; margin-left: auto; margin-right: auto;">
                <img id="profile-avatar-preview" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>" 
                     style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--md-sys-color-surface-variant);">
                <button onclick="document.getElementById('avatar-upload').click()" 
                        style="position: absolute; bottom: 0; right: 0; background: var(--md-sys-color-primary); border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; color: white;">
                    <span class="material-symbols-rounded" style="font-size: 18px;">edit</span>
                </button>
            </div>
            <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(this)">

            <input type="text" id="profile-name-input" class="code-input" placeholder="Your Name" style="text-align: left; font-family: 'Inter'; letter-spacing: normal; font-size: 18px;">
            
            <button class="btn-primary" onclick="saveProfile()" style="margin-top: 20px;">
                Continue
            </button>
        </div>
    </div>

    <!-- SETUP VIEW -->
    <div id="view-setup" class="view active">
        <div class="setup-content">
            <span class="material-symbols-rounded" style="font-size: 64px; color: var(--md-sys-color-primary);">cell_tower</span>
            <h1 style="margin-top:16px;">Waves</h1>
            <p style="opacity: 0.7;">Control your Polygol display</p>
            
            <!-- Device List Container -->
            <div id="device-list-container" style="width: 100%; display: none; margin-top: 24px;">
                <div id="device-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
                <button class="btn-primary" style="background: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface); margin-top: 20px;" onclick="showNewDeviceInput()">
                    <span class="material-symbols-rounded">add</span> Pair New Device
                </button>
                <button class="icon-btn" style="width: 100%; margin-top: 10px; font-size: 14px; opacity: 0.7; border-radius: 20px;" onclick="editProfile()">
                    <span class="material-symbols-rounded" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">edit</span> Edit Profile
                </button>
            </div>

            <!-- New Device Input Container -->
            <div id="new-device-container" style="width: 100%;">
                <p style="opacity: 0.7;">Open Settings > Connections > Show PIN to start pairing</p>
                <p style="opacity: 0.7; text-align:center;">Enter the PIN shown on the Display</p>
                
                <input type="text" id="input-code" class="code-input" placeholder="••••••••" maxlength="8">
                
                <button class="btn-primary" id="btn-connect" style="margin-top:0;">
                    Pair
                </button>

                <button id="cancel-add-btn" class="icon-btn" style="margin-top: 20px; display: none; width: 100%; border-radius: 50px;" onclick="showDeviceList()">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- 2. VERIFICATION VIEW -->
    <div id="view-auth" class="view">
        <div class="setup-content">
            <h2>Verification</h2>
            <p style="opacity: 0.7; text-align:center;">Tap the emoji shown on the Display</p>
            <div id="emoji-container" class="emoji-grid"></div>
        </div>
    </div>

    <!-- REMOTE DASHBOARD VIEW -->
    <div id="view-remote" class="view">
        <div class="top-app-bar">
            <div class="connection-status">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">Connecting</span>
            </div>
            <div id="remote-system-status" class="status-bar-remote">
                <div class="status-group" id="status-toggles">
                    <div class="status-pill" id="network-pill">
                        <span class="material-symbols-rounded" style="font-size: 16px;">wifi_off</span>
                    </div>
                </div>
                <div class="status-group">
                    <div class="status-pill" id="battery-pill">
                        <span class="material-symbols-rounded" style="font-size: 16px;">battery_full</span>
                        <span>100%</span>
                    </div>
                </div>
                <button class="icon-btn" onclick="disconnect()">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
        </div>

        <div id="default-dashboard-ui">
            <!-- Active Mini App Pill -->
            <div id="mini-app-pill" class="mini-app-pill" onclick="openActiveMiniApp()">
                <img id="mini-app-pill-icon" src="">
                <div id="mini-app-pill-name" class="info">App Name</div>
                <div class="action-btn">Open</div>
            </div>

            <!-- Live Activity Container -->
            <div id="remote-live-activity-container"></div>

            <div class="slider-container" style="margin-top: 0; margin-bottom: 12px; background: var(--md-sys-color-primary-container);">
                <span class="material-symbols-rounded">sunny</span>
                <input type="range" id="remote-brightness" min="20" max="100" onchange="sendCommand('setBrightness', this.value)">
            </div>

            <div class="slider-container" style="margin-top: 0; margin-bottom: 12px; background: var(--md-sys-color-primary-container);">
                <span class="material-symbols-rounded">thermometer</span>
                <input type="range" id="remote-temperature" min="-10" max="10" step="1" value="0" onchange="sendCommand('setTemperature', this.value)">
            </div>

            <!-- Quick Settings -->
            <div class="qs-grid">
                <button class="qs-btn" id="qs-silent" onclick="toggleQS('silent')">
                    <span class="material-symbols-rounded">notifications</span>
                </button>
                <button class="qs-btn" id="qs-night" onclick="toggleQS('night')">
                    <span class="material-symbols-rounded">bedtime</span>
                </button>
                <button class="qs-btn" id="qs-focus" onclick="toggleQS('focus')">
                    <span class="material-symbols-rounded">filter_tilt_shift</span>
                </button>
                <button class="qs-btn" id="qs-theme" onclick="toggleQS('theme')">
                    <span class="material-symbols-rounded">radio_button_partial</span>
                </button>
            </div>

            <!-- Media Player -->
            <div class="media-player" style="display: none;">
                <img id="media-art" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="album-art">
                <div class="track-info">
                    <h3 id="media-title">No Media</h3>
                    <p id="media-artist">Not Playing</p>
                </div>
                <div class="media-controls">
                    <button class="icon-btn" onclick="sendMedia('prev')"><span class="material-symbols-rounded" style="font-size: 32px;">skip_previous</span></button>
                    <button class="play-pause" onclick="sendMedia('playPause')"><span class="material-symbols-rounded" style="font-size: 36px;">play_arrow</span></button>
                    <button class="icon-btn" onclick="sendMedia('next')"><span class="material-symbols-rounded" style="font-size: 32px;">skip_next</span></button>
                </div>
            </div>
    
            <div class="grid-2">
                <button class="action-card" onclick="sendCommand('toggleSleep')">
                    <span class="material-symbols-rounded" style="font-size: 32px;">power_settings_new</span>
                    <span class="label-large">Sleep</span>
                </button>
                <button class="action-card" onclick="sendCommand('home')">
                    <span class="material-symbols-rounded" style="font-size: 32px;">home</span>
                    <span class="label-large">Home</span>
                </button>
                 <button class="action-card" onclick="requestScreenshot()">
                    <span class="material-symbols-rounded" style="font-size: 32px;">airplay</span>
                    <span class="label-large">Preview</span>
                </button>
                 <button class="action-card" onclick="toggleAppDrawer()">
                    <span class="material-symbols-rounded" style="font-size: 32px;">grid_view</span>
                    <span class="label-large">Applications</span>
                </button>
                <button class="action-card" onclick="openWallpapers()">
                    <span class="material-symbols-rounded" style="font-size: 32px;">filter_vintage</span>
                    <span class="label-large">Wallpaper</span>
                </button>
                <button class="action-card" onclick="openAnnouncementSheet()">
                    <span class="material-symbols-rounded" style="font-size: 32px;">campaign</span>
                    <span class="label-large">Announce</span>
                </button>
            </div>

            <!-- Live Activities & Notifications -->
            <div id="remote-notifications-area" style="display: none; flex-direction: column; gap: 8px; margin-top: 24px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0;">Activity</h2>
                    <button class="icon-btn" onclick="sendCommand('clearNotifications')"><span class="material-symbols-rounded">clear_all</span></button>
                </div>
                <div id="remote-notifications-list" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <!-- Widget Previews -->
            <div id="remote-widgets-area" style="display: none; flex-direction: column; gap: 8px; margin-top: 24px;">
                <div id="remote-widgets-list" class="widget-grid-remote"></div>
            </div>
        </div>

        <div id="app-specific-ui" style="display: none;">
            <div class="top-app-bar" style="margin-bottom: 20px;">
                <button class="icon-btn" onclick="exitAppUI()"><span class="material-symbols-rounded">arrow_back</span></button>
                <span id="app-ui-title" style="font-weight: 500; font-size: 18px;">App Name</span>
                <div style="width: 40px;"></div> <!-- Spacer -->
            </div>
            <div id="app-components-container" style="display: flex; flex-direction: column; gap: 16px;"></div>
        </div>
    </div>

    <!-- App Drawer Sheet -->
    <div id="app-drawer-sheet" class="app-drawer-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
            <h2>Applications</h2>
            <button class="icon-btn" onclick="toggleAppDrawer()"><span class="material-symbols-rounded">close</span></button>
        </div>
        
        <div class="segment-control">
            <button id="tab-all" class="segment-btn active" onclick="switchDrawerTab('all')">All</button>
            <button id="tab-mini" class="segment-btn" onclick="switchDrawerTab('mini')">Waves</button>
        </div>

        <div id="app-list-container"></div>
    </div>

    <!-- Wallpaper Sheet -->
    <div id="wallpaper-sheet" class="app-drawer-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
            <h2>Wallpapers</h2>
            <button class="icon-btn" onclick="toggleWallpaperSheet()"><span class="material-symbols-rounded">close</span></button>
        </div>
        <div id="wallpaper-list-container" class="wallpaper-grid">
            <p>Loading</p>
        </div>
    </div>

    <!-- Announcement Sheet -->
    <div id="announce-sheet" class="app-drawer-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
            <h2>Announce</h2>
            <button class="icon-btn" onclick="toggleAnnouncementSheet()"><span class="material-symbols-rounded">close</span></button>
        </div>
    
        <textarea id="announce-input" class="code-input" style="text-align: left; font-size: 18px; letter-spacing: normal; text-transform: none; min-height: 120px; font-family: 'Inter', sans-serif;" placeholder="Message"></textarea>
    
        <div class="filled-card" style="margin-top: 16px; cursor: pointer;" onclick="toggleAnnounceTTS()">
            <span class="material-symbols-rounded">record_voice_over</span>
            <div style="flex:1; font-weight:500;">Read aloud</div>
            <!-- Checkbox Logic -->
            <span id="announce-tts-icon" class="material-symbols-rounded" style="color: var(--md-sys-color-on-surface);">check_circle</span>
        </div>
    
        <button class="btn-primary" onclick="sendAnnouncement()">
            <span class="material-symbols-rounded">send</span> Send
        </button>
    </div>

    <!-- Settings View Container -->
    <div id="settings-ui" class="settings-frame-container">
        <div class="top-app-bar" style="background: var(--md-sys-color-surface); padding: 10px;">
            <button class="icon-btn" onclick="closeRemoteSettings()"><span class="material-symbols-rounded">arrow_back</span></button>
            <span style="font-weight: 500;">System Settings</span>
            <div style="width: 40px;"></div>
        </div>
        <iframe id="settings-frame" src=""></iframe>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshot-view" class="screenshot-modal">
        <button onclick="this.parentElement.classList.remove('open')"><span class="material-symbols-rounded">close</span></button>
        <img id="screenshot-img" src="">
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="screenshot-modal" style="background: var(--md-sys-color-surface);">
        <div style="text-align: center; width: 100%; padding: 20px;">
            <h2 id="upload-msg">Select items</h2>
            <p style="opacity: 0.7; margin-bottom: 30px;">Polygol is requesting items.</p>
            
            <input type="file" id="remote-file-input" style="display: none;">
            
            <button class="btn-primary" onclick="document.getElementById('remote-file-input').click()" style="width: 200px; margin: auto; position: static; border-radius: 50px; background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); font-weight: 500; font-family: 'Inter', sans-serif;">
                Select
            </button>
            <br><br>
            <button class="icon-btn" onclick="document.getElementById('upload-modal').classList.remove('open')" style="position: static; border-radius: 50px; width: 48px; height: 48px; color: var(--md-sys-color-on-primary); background: transparent;">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
    </div>

    <script>
        // Manually set the worker path to the CDN URL to prevent CORS/resolution errors
        if (typeof QrScanner !== 'undefined') {
            QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';
        }
        
        const CONFIG = { 
            appId: 'polygol-connect-v1',
            trackerUrls: [
                'wss://tracker.openwebtorrent.com',
                'wss://tracker.btorrent.xyz',
                'wss://tracker.webtorrent.dev',
                'wss://tracker.sloppyta.co:443/announce',
                'wss://tracker.novage.com.ua:443/announce',
                'wss://tracker.nanoha.org:443/announce',
                'wss://tracker.ghostchu-services.top:443/announce',
                'wss://tracker.files.fm:7073/announce'
            ],
            rtcConfig: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };
        let room, sendAction;
        let currentConfig = null;
        let currentRemoteApp = null;
        let pendingAppLaunch = null; // Tracks which app the user requested to view
        let activeMiniApp = null;
        let appListData = [];
        let drawerTab = 'all'; // 'all' or 'mini'
        let userProfile = null; // { name, avatar }
        let announceTTS = true; // Default state

        function loadUserProfile() {
            const raw = localStorage.getItem('waves_user_profile');
            if (raw) {
                userProfile = JSON.parse(raw);
                return true;
            }
            return false;
        }

        async function handleAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                // Compress image
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // Resize to 100x100 for icon
                        canvas.width = 100;
                        canvas.height = 100;
                        ctx.drawImage(img, 0, 0, 100, 100);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        document.getElementById('profile-avatar-preview').src = dataUrl;
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        function saveProfile() {
            const nameInput = document.getElementById('profile-name-input');
            const avatarImg = document.getElementById('profile-avatar-preview');
            
            const name = nameInput.value.trim();
            const avatar = avatarImg.src;
            
            if (!name) {
                alert("Please enter a name.");
                return;
            }
        
            userProfile = { name, avatar };
            localStorage.setItem('waves_user_profile', JSON.stringify(userProfile));
            
            // IF we are currently connected to a host, send an immediate ping 
            // with the new profile so the TV updates instantly.
            if (sendAction && currentConfig) {
                sendCommand('ping'); // The ping command now carries the profile data
                showView('view-remote'); // Go back to remote
            } else {
                // Otherwise go to device list
                checkInitState();
            }
        }
        
        function editProfile() {
            if (userProfile) {
                document.getElementById('profile-name-input').value = userProfile.name;
                document.getElementById('profile-avatar-preview').src = userProfile.avatar;
            }
            showView('view-profile-setup');
        }

        // --- UI Helpers ---
        function applyTheme(rgb) {
            if (!rgb || rgb.length < 3) return;
            const [r, g, b] = rgb;
            
            const root = document.documentElement;
            
            // 1. Set Base RGB
            root.style.setProperty('--theme-r', r);
            root.style.setProperty('--theme-g', g);
            root.style.setProperty('--theme-b', b);
            
            // 2. Calculate Luminance (YIQ formula) to determine text color
            // Returns value between 0 (black) and 255 (white)
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            
            // If color is dark (< 128), text should be white. If bright, text should be black.
            const onPrimary = (yiq >= 128) ? '#000000' : '#ffffff';
            root.style.setProperty('--md-sys-color-on-primary', onPrimary);
            
            // 3. Update Browser Chrome
            const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) metaTheme.setAttribute('content', hex);
        }
        
        function showLoading(msg = 'Loading') {
            const t = document.getElementById('loading-toast');
            t.innerText = msg;
            t.classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading-toast').classList.remove('show');
        }

        // --- Navigation Logic ---
        
        // Internal helper to switch visibility without history modification
        function _renderView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            const el = document.getElementById(id);
            if(el) el.classList.add('active');
        }

        // Main navigation function with History support
        function showView(id) {
            _renderView(id);
            // Push state if different
            const hash = '#' + id.replace('view-', '');
            if (window.location.hash !== hash) {
                history.pushState({ view: id }, '', hash);
            }
        }

        // Handle Browser Back Button
        window.addEventListener('popstate', (event) => {
            const state = event.state;
            
            // 1. Close Overlays (Settings, Sheets, Modals)
            ['app-drawer-sheet', 'wallpaper-sheet', 'announce-sheet'].forEach(id => {
                const el = document.getElementById(id);
                if (el && el.classList.contains('open')) el.classList.remove('open');
            });
            
            const uploadModal = document.getElementById('upload-modal');
            if(uploadModal && uploadModal.classList.contains('open')) uploadModal.classList.remove('open');

            const screenshotModal = document.getElementById('screenshot-view');
            if(screenshotModal && screenshotModal.classList.contains('open')) screenshotModal.classList.remove('open');

            // 2. Restore View based on state
            if (state && state.view) {
                _renderView(state.view);
                
                // Special Case: If user backs out of Remote View to Setup, 
                // force a reload to ensure clean disconnection state.
                if (state.view === 'view-setup' && currentConfig) {
                    window.location.reload();
                }
            } else {
                // Default fallback
                _renderView('view-setup');
            }
        });
        
        function setStatus(connected, label = null) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if (!dot || !text) return;
            
            if (connected) {
                dot.classList.add('connected');
                // Use provided label, or find name from storage, or default
                if (label) {
                    text.innerText = label;
                } else if (currentConfig) {
                    const devices = loadDevices();
                    const dev = devices.find(d => d.config.r === currentConfig.r);
                    text.innerText = dev ? dev.name : "Connected";
                } else {
                    text.innerText = "Connected";
                }
            } else {
                dot.classList.remove('connected');
                text.innerText = "Disconnected";
            }
        }

        // --- System Status ---
        function applySystemContext(context) {
            if (!context) return;
            
            const body = document.body;
            
            // Theme
            if (context.theme === 'light') body.classList.add('light-theme');
            else body.classList.remove('light-theme');
            
            // Contrast
            if (context.highContrast) body.classList.add('high-contrast');
            else body.classList.remove('high-contrast');
            
            // Motion
            if (context.reduceMotion) body.classList.add('reduce-animations');
            else body.classList.remove('reduce-animations');
            
            // Update iframe theme if open
            const frame = document.getElementById('settings-frame');
            if (frame && frame.contentWindow) {
                frame.contentWindow.postMessage({ 
                    type: 'themeUpdate', 
                    theme: context.theme 
                }, '*');
            }
        }
        
        function updateSystemStatusUI(status) {
            if (!status) return;
            
            // QS Toggles state update
            const setQS = (id, active, iconOn, iconOff) => {
                const btn = document.getElementById(id);
                if(btn) {
                    if(active) {
                        btn.classList.add('active');
                        btn.querySelector('span').innerText = iconOn;
                    } else {
                        btn.classList.remove('active');
                        btn.querySelector('span').innerText = iconOff;
                    }
                }
            };

            setQS('qs-silent', status.silent, 'notifications_off', 'notifications');
            setQS('qs-night', status.night, 'moon_stars', 'bedtime');
            setQS('qs-focus', status.minimal, 'screen_record', 'filter_tilt_shift'); // Icon might not change
            
            // Theme check
            const isLight = status.context && status.context.theme === 'light';
            setQS('qs-theme', isLight, 'radio_button_checked', 'radio_button_partial');

            // Network Indicator Logic
            const netPill = document.getElementById('network-pill');
            if (status.network) {
                let icon = 'wifi_off';
                let label = 'Offline';
                const net = status.network;

                if (net.online) {
                    // Logic mirrored from System index.js
                    if (net.type === 'ethernet') {
                        icon = 'settings_ethernet';
                        label = 'Eth';
                    } else if (net.type === 'wifi' || net.type === 'wimax') {
                        // WiFi Signal strength approximation based on effectiveType is limited in standard API,
                        // but we can map effectiveType if available, or default to full wifi.
                        // Standard Navigator.connection usually gives 4g for good wifi.
                        icon = 'network_wifi';
                        label = 'WiFi';
                    } else {
                        // Cellular / Default
                        const typeMap = {
                            '4g': 'signal_cellular_4_bar',
                            '3g': 'signal_cellular_3_bar',
                            '2g': 'signal_cellular_2_bar',
                            'slow-2g': 'signal_cellular_1_bar'
                        };
                        icon = typeMap[net.effectiveType] || 'signal_cellular_null';
                        label = (net.effectiveType || 'Cell').toUpperCase();
                    }
                }
                
                netPill.innerHTML = `<span class="material-symbols-rounded" style="font-size: 16px;">${icon}</span>`;
            } else {
                // Fallback
                netPill.innerHTML = `<span class="material-symbols-rounded" style="font-size: 16px;">${status.wifi ? 'network_wifi' : 'wifi_off'}</span>`;
            }
    
            // Battery
            if (status.battery) {
                const batEl = document.getElementById('battery-pill');
                let icon = 'battery_full';
                
                if (status.battery.charging) {
                    icon = 'battery_charging_full';
                } else {
                    const lvl = status.battery.level;
                    if (lvl <= 15) icon = 'battery_1_bar';
                    else if (lvl <= 30) icon = 'battery_2_bar';
                    else if (lvl <= 50) icon = 'battery_3_bar';
                    else if (lvl <= 65) icon = 'battery_4_bar';
                    else if (lvl <= 85) icon = 'battery_5_bar';
                    else if (lvl <= 99) icon = 'battery_6_bar';
                    else icon = 'battery_full';
                }
                
                batEl.innerHTML = `<span class="material-symbols-rounded" style="font-size: 16px;">${icon}</span><span>${status.battery.level}%</span>`;
            }
        }
    
        // --- Settings Bridge ---
        function openRemoteSettings() {
            history.pushState({ overlay: 'settings' }, '', '#settings');
            const frame = document.getElementById('settings-frame');
            const container = document.getElementById('settings-ui');
            document.getElementById('default-dashboard-ui').style.display = 'none';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            
            // Load the settings app if not already loaded
            if (!frame.src || frame.src === 'about:blank') {
                // Point to the hosted settings app
                frame.src = 'https://polygol.github.io/assets/gurapp/intl/settings/index.html';
            }
        }

        // Bridge Logic: Listen for messages from the Settings Iframe
        window.addEventListener('message', (event) => {
            const frame = document.getElementById('settings-frame');
            if (event.source !== frame.contentWindow) return;
    
            const data = event.data;
    
            // 1. Initial Handshake
            if (data.type === 'gurapp-ready') {
                console.log("[Remote] Settings app ready, sending handshake.");
                
                // 1. Tell API it's inside Polygol (Unlocks full screen layout)
                frame.contentWindow.postMessage({ type: 'gurasuraisu-api-present' }, '*');
                
                // 2. Tell Settings App to start
                frame.contentWindow.postMessage({ type: 'settings-app-ready' }, '*');
                
                // 3. Populate Data
                sendCommand('getAllSettings');
            }
    
            // 2. API Calls from Settings App
            if (data.action === 'callGurasuraisuFunc') {
                const func = data.functionName;
                const args = data.args;
    
                if (func === 'setLocalStorageItem') {
                    // Settings app changing a setting -> Send to Host
                    sendCommand('setSetting', { key: args[0], value: args[1] });
                } 
                else if (func === 'getLocalStorageAll') {
                    // Settings app asking for storage list -> Send to Host
                    sendCommand('getAllSettings');
                }
                // For simple navigation/UI sounds, ignore or handle locally
            }
        });
    
        function closeRemoteSettings() {
            if (window.location.hash === '#settings') {
                history.back();
            } else {
                document.getElementById('settings-ui').style.display = 'none';
                document.getElementById('default-dashboard-ui').style.display = 'block';
            }
        }

        function toggleAppDrawer() {
            const el = document.getElementById('app-drawer-sheet');
            if (el.classList.contains('open')) {
                // Close
                if(window.location.hash === '#apps') history.back();
                else el.classList.remove('open');
            } else {
                // Open
                history.pushState({ overlay: 'apps' }, '', '#apps');
                el.classList.add('open');
            }
        }

        function openWallpapers() {
            history.pushState({ overlay: 'wallpapers' }, '', '#wallpapers');
            document.getElementById('wallpaper-sheet').classList.add('open');
            sendCommand('getWallpapers');
        }

        function toggleWallpaperSheet() {
            const el = document.getElementById('wallpaper-sheet');
            if (el.classList.contains('open')) {
                if(window.location.hash === '#wallpapers') history.back();
                else el.classList.remove('open');
            }
        }

        function toggleQS(id) {
            sendCommand('toggleQS', { id: id });
        }

        function renderWallpaperList(list) {
            const container = document.getElementById('wallpaper-list-container');
            container.innerHTML = '';
            
            if (!list || list.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align:center; opacity:0.5;">No wallpapers found.</p>';
                return;
            }
            
            list.forEach(wp => {
                const item = document.createElement('div');
                item.className = `wallpaper-item ${wp.active ? 'active' : ''}`;
                item.onclick = () => {
                    sendCommand('setWallpaper', { index: wp.index });
                    // Optimistic update
                    document.querySelectorAll('.wallpaper-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                };
                
                if (wp.thumbnail) {
                    item.innerHTML = `<img src="${wp.thumbnail}">`;
                } else {
                    item.innerHTML = `<div style="width:100%;height:100%;background:rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;color:white;font-size:12px;">Image</div>`;
                }
                
                container.appendChild(item);
            });
        }

        function updateMediaUI(metadata, playbackState) {
            const player = document.querySelector('.media-player');
            
            if (!metadata) {
                if(player) player.style.display = 'none';
                return;
            }
            
            if(player) player.style.display = 'flex';
            
            // Update Text
            document.getElementById('media-title').innerText = metadata.title || "Unknown";
            document.getElementById('media-artist').innerText = metadata.artist || "Unknown";
            
            // Update Artwork
            const artImg = document.getElementById('media-art');
            let artSrc = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            if (metadata.artwork && metadata.artwork.length > 0) {
                artSrc = metadata.artwork[0].src;
            }
            artImg.src = artSrc;
    
            // Update Play/Pause Button Icon
            const playBtnIcon = document.querySelector('.play-pause span');
            if (playbackState === 'playing') {
                playBtnIcon.innerText = 'pause';
            } else {
                playBtnIcon.innerText = 'play_arrow';
            }
    
            // --- Native Media Session API (Lock Screen Controls) ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: metadata.title || "Polygol Media",
                    artist: metadata.artist || "Remote Control",
                    artwork: [
                        { src: artSrc, sizes: '512x512', type: 'image/png' }
                    ]
                });
    
                // Update playback state for OS
                navigator.mediaSession.playbackState = playbackState || 'none';
    
                // Bind handlers (only need to do this once, but doing it here ensures data availability)
                navigator.mediaSession.setActionHandler('play', () => sendMedia('playPause'));
                navigator.mediaSession.setActionHandler('pause', () => sendMedia('playPause'));
                navigator.mediaSession.setActionHandler('previoustrack', () => sendMedia('prev'));
                navigator.mediaSession.setActionHandler('nexttrack', () => sendMedia('next'));
            }
        }

        function updateBrightnessUI(value) {
            const slider = document.getElementById('remote-brightness');
            if(slider) slider.value = value;
        }
        
        function renderAppList(apps) {
            const container = document.getElementById('app-list-container');
            container.innerHTML = '';
            
            let filteredApps = apps;
            if (drawerTab === 'mini') {
                filteredApps = apps.filter(app => app.hasMiniApp);
            }
            
            if(!filteredApps || filteredApps.length === 0) {
                const msg = drawerTab === 'mini' ? 'No Mini Apps found.' : 'No apps found on host.';
                container.innerHTML = `<p style="text-align:center; opacity:0.5; padding:20px;">${msg}</p>`;
                return;
            }

            filteredApps.forEach(app => {
                const div = document.createElement('div');
                div.className = 'app-list-item';
                div.onclick = () => {
                    // Set pending state and show loading
                    // If Mini App tab is active, we WANT to open the remote UI.
                    if (drawerTab === 'mini') {
                        // For Mini Apps, launch silently in background (if not already running)
                        // and prepare to show the Remote UI
                        sendCommand('launchAppSilently', { url: app.url });
                        pendingAppLaunch = app.name;
                        showLoading(`Opening ${app.name}`);
                    } else {
                        // Just launching on host, no local loading needed
                        sendCommand('launchApp', { url: app.url });
                    }
                    
                    // 3. Close drawer
                    toggleAppDrawer(); 
                    
                    // 4. Timeout to clear loading if app doesn't respond
                    if (drawerTab === 'mini') {
                        setTimeout(() => {
                            if (pendingAppLaunch === app.name) {
                                hideLoading();
                                pendingAppLaunch = null;
                            }
                        }, 5000);
                    }
                };
                
                const imgHtml = app.icon 
                    ? `<img src="${app.icon}" onerror="this.style.display='none'">` 
                    : '<span class="material-symbols-rounded" style="font-size:32px; opacity:0.7;">apps</span>';

                div.innerHTML = `
                    ${imgHtml}
                    <span style="font-size:16px; font-weight:500;">${app.name}</span>
                `;
                container.appendChild(div);
            });
        }
        
        function openAnnouncementSheet() {
            history.pushState({ overlay: 'announce' }, '', '#announce');
            document.getElementById('announce-sheet').classList.add('open');
            setTimeout(() => document.getElementById('announce-input').focus(), 300);
        }
        
        function toggleAnnouncementSheet() {
            const el = document.getElementById('announce-sheet');
            if (el.classList.contains('open')) {
                if(window.location.hash === '#announce') history.back();
                else {
                    el.classList.remove('open');
                    document.getElementById('announce-input').blur();
                }
            }
        }
        
        function toggleAnnounceTTS() {
            announceTTS = !announceTTS;
            const icon = document.getElementById('announce-tts-icon');
            
            if (announceTTS) {
                icon.innerText = 'check_circle';
                icon.style.opacity = '1';
            } else {
                icon.innerText = 'radio_button_unchecked';
                icon.style.opacity = '0.5';
            }
        }
        
        function sendAnnouncement() {
            const text = document.getElementById('announce-input').value.trim();
            if (!text) return;
        
            // Send command with TTS preference
            sendCommand('announce', { 
                text: text, 
                tts: announceTTS 
            });
        
            // Cleanup
            document.getElementById('announce-input').value = "";
            toggleAnnouncementSheet();
        }

        // --- Networking ---
        function connect(config) {
            if (!window.Trystero) {
                // Wait for library
                window.addEventListener('trystero-ready', () => connect(config), { once: true });
                return;
            }

            // Case 1: We have a PSK (Restoring session)
            if (config.k) {
                startRemoteSession(config);
            } 
            // Case 2: No PSK (New connection handshake)
            else {
                startHandshake(config.r);
            }
        }

        // 1. New Connection Handshake
        function startHandshake(roomId) {
            console.log("Starting handshake for room:", roomId);
            showLoading("Connecting");
            
            if (room) {
                try { room.leave(); } catch(e) {}
            }

            room = window.Trystero.joinRoom(CONFIG, roomId);
            const [send, get] = room.makeAction('waves-cmd');
            
            // Even if we don't process updates during handshake, we must acknowledge the action type
            // to prevent Trystero from throwing an error if the host broadcasts state.
            room.makeAction('waves-update'); 
            
            // Handle Auth Messages
            get((payload, peerId) => {
                hideLoading();
                
                if (payload.type === 'challenge') {
                    renderEmojiGrid(payload.options, peerId, send);
                    showView('view-auth');
                } 
                else if (payload.type === 'authorized') {
                    // Update device name from payload if available
                    const deviceName = payload.deviceName || `Device ${roomId.substring(0,4)}`;
                    
                    const newConfig = { r: roomId, k: payload.psk };
                    saveDevice(newConfig, deviceName);
                    
                    room.leave(); 
                    setTimeout(() => startRemoteSession(newConfig), 500);
                } 
                else if (payload.type === 'auth_failed') {
                    if (payload.reason === 'profile_missing') {
                        alert("Connection rejected: You must set a profile name.");
                        showView('view-profile-setup');
                    } else {
                        alert("Incorrect Emoji");
                        window.location.reload();
                    }
                }
                else if (payload.type === 'discovery_disabled') {
                    alert("Connection failed: The host device is not accepting new devices");
                    window.location.reload();
                }
            });

            // Send Hello/Auth immediately on join to identify
            room.onPeerJoin((peerId) => {
                setStatus(true);
                send({ 
                    type: 'hello', 
                    auth: null, // No key yet
                    profile: userProfile 
                }, peerId);
            });
        }
        
        // 2. Authenticated Session (The actual remote control)
        function startRemoteSession(config) {
            currentConfig = config;
            showView('view-remote');

            // Find device name for UI header
            const devices = loadDevices();
            const dev = devices.find(d => d.config.r === config.r);
            if(dev) {
                setStatus(false, dev.name + " (Connecting)"); // Show name while connecting
            }

            console.log("Starting secure session...");
            if (room) {
                try { room.leave(); } catch(e){}
            }
            
            room = window.Trystero.joinRoom(CONFIG, config.r);
            
            // Track handshake status per peer
            let peerHandshakeStatus = {}; 

            // Setup Channels
            const [sendCmd, getCmd] = room.makeAction('waves-cmd');
            sendAction = sendCmd;
            const [sendUpd, getUpd] = room.makeAction('waves-update');
            
            // Listen for State Updates (Media, Brightness)
            getUpd((payload) => {
                if (payload.type === 'appUI') {
                    if (payload.data && payload.data.appName) {
                        activeMiniApp = payload.data;
                    } else {
                        activeMiniApp = null;
                    }
                    updateMiniAppPill();

                    if (payload.data && payload.data.appName) {
                        if (pendingAppLaunch === payload.data.appName || currentRemoteApp === payload.data.appName) {
                            renderAppUI(payload.data.appName, payload.data.components);
                            pendingAppLaunch = null;
                            hideLoading();
                        }
                    } else {
                        if (currentRemoteApp) { 
                            exitAppUI(); 
                        }
                    }
                } else if (payload.type === 'appUIUpdate') {
                    if (currentRemoteApp && payload.data.appName === currentRemoteApp) {
                        updateAppComponents(payload.data.updates);
                    }
                } else if (payload.type === 'mediaUpdate') {
                    updateMediaUI(payload.data.metadata, payload.data.playbackState);
                } else if (payload.type === 'state') {
                    if (payload.data.systemStatus) {
                        if (payload.data.systemStatus.context) {
                            applySystemContext(payload.data.systemStatus.context);
                        }
                        updateSystemStatusUI(payload.data.systemStatus);
                    }
                    if (payload.data.accentColor) {
                        applyTheme(payload.data.accentColor);
                    }
                    updateBrightnessUI(payload.data.brightness);
                    const tempSlider = document.getElementById('remote-temperature');
                    if(tempSlider && payload.data.temperature !== undefined) {
                        tempSlider.value = payload.data.temperature;
                    }
                    if(payload.data.media) {
                        updateMediaUI(payload.data.media, payload.data.mediaState);
                    } else {
                        const player = document.querySelector('.media-player');
                        if(player) player.style.display = 'none';
                    }
                    if (payload.data.appUI) {
                        activeMiniApp = payload.data.appUI;
                        updateMiniAppPill();
                        if (pendingAppLaunch === payload.data.appUI.appName) {
                            renderAppUI(payload.data.appUI.appName, payload.data.appUI.components);
                            pendingAppLaunch = null;
                            hideLoading();
                        }
                    } else {
                        activeMiniApp = null;
                        updateMiniAppPill();
                    }
                    if (payload.data.notifications) {
                        renderRemoteNotifications(payload.data.notifications);
                    }
                } else if (payload.type === 'wallpaperUpdate') {
                    const wpEl = document.getElementById('remote-wallpaper');
                    if(wpEl) {
                        if(payload.data && (payload.data.startsWith('data:') || payload.data.startsWith('http') || payload.data.startsWith('blob:'))) {
                            wpEl.style.backgroundImage = `url('${payload.data}')`;
                        } else {
                            wpEl.style.backgroundImage = 'none';
                        }
                    }
                } else if (payload.type === 'notificationUpdate') {
                     renderRemoteNotifications(payload.data);
                } else if (payload.type === 'liveActivityStart') {
                    renderLiveActivityIframe(payload.data);
                } else if (payload.type === 'widgetUpdate') {
                    renderWidgetPreviews(payload.data);
                }
            });
            
            // Listen for Data Responses
            getCmd((payload, peerId) => {
                if (payload.type === 'welcome') {
                    console.log(`[Waves] Welcome received from ${peerId}`);
                    
                    // Mark peer as welcomed to stop retries
                    if (peerHandshakeStatus[peerId]) {
                        peerHandshakeStatus[peerId].welcomed = true;
                    }

                    if (payload.deviceName) {
                        saveDevice(config, payload.deviceName);
                        setStatus(true, payload.deviceName);
                    }
                    
                    // Trigger state sync now that we are trusted
                    sendCommand('getState');
                    setTimeout(() => sendCommand('getApps'), 500);
                } else if (payload.type === 'auth_failed') {
                    if (payload.reason === 'profile_missing') {
                        alert("Connection rejected: You must set up your profile.");
                        showView('view-profile-setup');
                    } else {
                        alert("Incorrect Emoji or Auth Failed");
                        window.location.reload();
                    }
                } else if (payload.type === 'screenshot') {
                    const modalImg = document.getElementById('screenshot-img');
                    if(modalImg) {
                        modalImg.src = payload.data;
                        document.getElementById('screenshot-view').classList.add('open');
                    }
                } else if (payload.type === 'appList') {
                    appListData = payload.data;
                    renderAppList(payload.data);
                    updateMiniAppPill();
                } else if (payload.type === 'wallpaperList') {
                    renderWallpaperList(payload.data);
                } else if (payload.type === 'requestUpload') {
                    const { accept, multiple, requestId } = payload.data;
                    const modal = document.getElementById('upload-modal');
                    const input = document.getElementById('remote-file-input');
                    input.accept = accept || '*/*';
                    input.multiple = multiple || false;
                    input.dataset.requestId = requestId || '';
                    modal.classList.add('open');
                } else if (payload.type === 'settingsData') {
                    const frame = document.getElementById('settings-frame');
                    if (frame.contentWindow) {
                        frame.contentWindow.postMessage({ type: 'localStorageAllValues', value: payload.data }, '*');
                        payload.data.forEach(item => {
                            frame.contentWindow.postMessage({ 
                                type: 'localStorageItemValue', 
                                key: item.key, 
                                value: item.value 
                            }, '*');
                        });
                    }
                }
            });

            room.onPeerJoin((peerId) => {
                const d = loadDevices().find(d => d.config.r === config.r);
                setStatus(true, d ? d.name : "Connected");
                
                // Initialize status tracking
                peerHandshakeStatus[peerId] = { welcomed: false, attempts: 0 };

                // Handshake Loop
                const attemptHandshake = () => {
                    if (!peerHandshakeStatus[peerId] || peerHandshakeStatus[peerId].welcomed) return;
                    
                    if (peerHandshakeStatus[peerId].attempts > 5) {
                        console.warn(`[Waves] Handshake timeout for ${peerId}. Switching to broadcast.`);
                        // Last ditch effort: broadcast hello
                        sendCommand('hello', { auth: config.k, profile: userProfile });
                        return;
                    }

                    console.log(`[Waves] Sending Hello to ${peerId} (Attempt ${peerHandshakeStatus[peerId].attempts + 1})`);
                    
                    sendAction({ 
                        type: 'hello', 
                        auth: config.k,
                        profile: userProfile 
                    }, peerId);

                    peerHandshakeStatus[peerId].attempts++;
                    setTimeout(attemptHandshake, 1500);
                };

                attemptHandshake();
            });

            room.onPeerLeave((peerId) => {
                delete peerHandshakeStatus[peerId];
                // Check if any peers remain
                if (Object.keys(peerHandshakeStatus).length === 0) {
                    setStatus(false);
                }
            });
        }
    
        function exitAppUI() {
            document.getElementById('app-specific-ui').style.display = 'none';
            document.getElementById('default-dashboard-ui').style.display = 'block';
            currentRemoteApp = null;
        }
    
        function renderAppUI(appName, components) {
            currentRemoteApp = appName;
            
            // Switch Views
            document.getElementById('default-dashboard-ui').style.display = 'none';
            const container = document.getElementById('app-specific-ui');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            
            document.getElementById('app-ui-title').innerText = appName;
            const list = document.getElementById('app-components-container');
            list.innerHTML = '';
    
            // Render Components
            components.forEach(comp => {
                let el;
                
                // --- Button Component ---
                if (comp.type === 'button') {
                    el = document.createElement('button');
                    el.id = `comp_${comp.id}`; // Add ID
                    // Style based on 'style' prop: 'filled' (default), 'tonal', 'outlined'
                    if (comp.style === 'outlined') {
                        el.className = 'btn-primary';
                        el.style.background = 'transparent';
                        el.style.border = '1px solid var(--md-sys-color-primary)';
                        el.style.color = 'var(--md-sys-color-on-background)';
                    } else if (comp.style === 'tonal') {
                        el.className = 'btn-primary';
                        el.style.background = 'var(--md-sys-color-secondary-container)';
                        el.style.color = 'var(--md-sys-color-on-secondary-container)';
                    } else {
                        el.className = 'btn-primary'; // Default filled
                    }
                    
                    // Icon support
                    if (comp.icon) {
                        el.innerHTML = `<span class="material-symbols-rounded">${comp.icon}</span> ${comp.label}`;
                    } else {
                        el.innerText = comp.label;
                    }
                    
                    el.onclick = () => sendAppAction(comp.id);
                }
                
                // --- Text Component ---
                else if (comp.type === 'text') {
                    el = document.createElement('div');
                    el.id = `comp_${comp.id}`; // Add ID
                    el.innerText = comp.content;
                    if (comp.size === 'large') {
                        el.style.fontSize = '32px';
                        el.style.textAlign = 'center';
                    } else if (comp.size === 'medium') {
                        el.style.fontSize = '20px';
                        el.style.opacity = '0.8';
                    } else {
                        el.style.opacity = '0.6';
                    }
                }
    
                // --- Slider Component ---
                else if (comp.type === 'slider') {
                    el = document.createElement('div');
                    el.className = 'slider-container';
                    if (comp.icon) {
                        el.innerHTML = `<span class="material-symbols-rounded">${comp.icon}</span>`;
                    }
                    
                    const input = document.createElement('input');
                    input.id = `comp_${comp.id}`; // Add ID for live updates
                    input.type = 'range';
                    input.min = comp.min || 0;
                    input.max = comp.max || 100;
                    input.value = comp.value || 50;
                    
                    // Use 'input' event for smoother local feedback, sends 'change' on drop
                    input.oninput = (e) => sendAppAction(comp.id, e.target.value);
                    
                    el.appendChild(input);
                }

                // --- Image Component ---
                else if (comp.type === 'image') {
                    el = document.createElement('div');
                    el.style.display = 'flex';
                    el.style.justifyContent = 'center';
                    el.style.marginBottom = '16px';
                    
                    const img = document.createElement('img');
                    img.id = `comp_${comp.id}`;
                    img.src = comp.src || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    img.style.width = comp.width || '200px';
                    img.style.height = comp.height || '200px';
                    img.style.borderRadius = comp.style === 'rounded' ? '16px' : '0';
                    img.style.objectFit = 'cover';
                    img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                    
                    el.appendChild(img);
                }
    
                // --- Grid/Row Layout ---
                else if (comp.type === 'row') {
                    el = document.createElement('div');
                    el.style.display = 'flex';
                    el.style.gap = '12px';
                    el.style.alignItems = 'center';
                    
                    // Recursive rendering for row children
                    if (comp.components && Array.isArray(comp.components)) {
                        // Create a temporary container to render children into, then move them
                        // This reuses the logic without duplicating it, though a refactor to createComponent() would be cleaner.
                        // For this inline approach, we'll iterate manually to support basic nesting.
                        comp.components.forEach(childComp => {
                            // Simplified inline rendering for row items (Buttons & Text mostly)
                            if (childComp.type === 'button') {
                                const btn = document.createElement('button');
                                btn.id = `comp_${childComp.id}`;
                                btn.className = 'btn-primary';
                                btn.style.flex = '1';
                                btn.style.marginTop = '0';
                                if (childComp.style === 'outlined') {
                                    btn.style.background = 'transparent';
                                    btn.style.border = '1px solid var(--md-sys-color-primary)';
                                } else if (childComp.style === 'tonal') {
                                    btn.style.background = 'var(--md-sys-color-secondary-container)';
                                    btn.style.color = 'var(--md-sys-color-on-secondary-container)';
                                }
                                if (childComp.icon) btn.innerHTML = `<span class="material-symbols-rounded">${childComp.icon}</span>`;
                                else btn.innerText = childComp.label;
                                btn.onclick = () => sendAppAction(childComp.id);
                                el.appendChild(btn);
                            }
                            // Handle TEXT in row (Fix for Music App timers)
                            else if (childComp.type === 'text') {
                                const txt = document.createElement('div');
                                txt.id = `comp_${childComp.id}`;
                                txt.innerText = childComp.content;
                                txt.style.fontSize = childComp.size === 'large' ? '24px' : '14px';
                                txt.style.opacity = '0.8';
                                el.appendChild(txt);
                            }
                        });
                    }
                }
                
                // --- Input Component ---
                else if (comp.type === 'input') {
                    el = document.createElement('input');
                    el.type = 'text';
                    el.className = 'code-input'; 
                    el.style.textAlign = 'left';
                    el.style.fontSize = '16px';
                    el.style.letterSpacing = 'normal';
                    el.style.marginBottom = '0';
                    el.style.background = 'var(--md-sys-color-surface-variant)';
                    el.placeholder = comp.placeholder || '';
                    el.value = comp.value || '';
                    
                    el.onchange = (e) => sendAppAction(comp.id, e.target.value);
                }

                // --- List Component ---
                else if (comp.type === 'list') {
                    el = document.createElement('div');
                    el.style.display = 'flex';
                    el.style.flexDirection = 'column';
                    el.style.gap = '8px';

                    comp.items.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'filled-card'; 
                        itemEl.style.marginBottom = '0';
                        itemEl.style.cursor = 'pointer';
                        itemEl.onclick = () => sendAppAction(item.id);

                        let imgHtml = '';
                        if (item.image) {
                            imgHtml = `<img src="${item.image}" style="width: 48px; height: 48px; border-radius: 8px; object-fit: cover;">`;
                        }

                        itemEl.innerHTML = `
                            ${imgHtml}
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 16px;">${item.title}</div>
                                ${item.subtitle ? `<div style="font-size: 13px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.subtitle}</div>` : ''}
                            </div>
                        `;
                        el.appendChild(itemEl);
                    });
                }
    
                if (el) list.appendChild(el);
            });
        }
    
        function sendAppAction(id, value = null) {
            if (!currentRemoteApp) return;
            sendCommand('appAction', { 
                appName: currentRemoteApp, 
                id: id, 
                value: value 
            });
        }

        function updateMiniAppPill() {
            const pill = document.getElementById('mini-app-pill');
            if (!pill) return;

            if (activeMiniApp) {
                const appName = activeMiniApp.appName;
                // Find icon from the cached app list
                const appInfo = appListData.find(a => a.name === appName);
                const iconSrc = appInfo && appInfo.icon ? appInfo.icon : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                
                document.getElementById('mini-app-pill-icon').src = iconSrc;
                document.getElementById('mini-app-pill-name').innerText = appName;
                pill.classList.add('visible');
            } else {
                pill.classList.remove('visible');
            }
        }
        
        function openActiveMiniApp() {
            if (activeMiniApp) {
                renderAppUI(activeMiniApp.appName, activeMiniApp.components);
            }
        }

        function switchDrawerTab(tab) {
            drawerTab = tab;
            document.getElementById('tab-all').classList.toggle('active', tab === 'all');
            document.getElementById('tab-mini').classList.toggle('active', tab === 'mini');
            
            // Always re-render or request fresh data
            if (appListData.length > 0) {
                renderAppList(appListData);
            } else {
                sendCommand('getApps'); // Fetch if missing
            }
        }

        function renderLiveActivityIframe(data) {
            const container = document.getElementById('remote-live-activity-container');
            container.innerHTML = ''; // Clear previous
            if (!data || !data.url) return;

            const iframe = document.createElement('iframe');
            iframe.src = data.url;
            iframe.className = 'remote-activity-frame';
            iframe.style.height = data.height || '120px';
            container.appendChild(iframe);
        }

        function renderWidgetPreviews(widgets) {
            const container = document.getElementById('remote-widgets-list');
            const area = document.getElementById('remote-widgets-area');
            
            if (!widgets || widgets.length === 0) {
                area.style.display = 'none';
                return;
            }
            
            area.style.display = 'flex';
            container.innerHTML = '';
            
            widgets.forEach(w => {
                const el = document.createElement('div');
                el.className = 'widget-preview';
                el.innerHTML = `<img src="${w.img}">`;
                container.appendChild(el);
            });
        }

        function updateAppComponents(updates) {
            for (const [id, value] of Object.entries(updates)) {
                const el = document.getElementById(`comp_${id}`);
                if (!el) continue;

                if (el.tagName === 'INPUT' && el.type === 'range') {
                    el.value = value;
                } else if (el.tagName === 'DIV' && !el.classList.contains('slider-container')) {
                    el.innerText = value;
                } else if (el.tagName === 'IMG') {
                    el.src = value;
                }
                // Add other component types as needed
            }
        }

        function renderEmojiGrid(options, peerId, sendFunc) {
            const container = document.getElementById('emoji-container');
            container.innerHTML = '';
            
            options.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.innerText = emoji;
                btn.onclick = () => {
                    // Send Answer
                    sendFunc({ type: 'verify', answer: emoji }, peerId);
                    container.innerHTML = '<p style="grid-column: span 2; text-align: center; color: white;">Verifying</p>';
                };
                container.appendChild(btn);
            });
        }

        function sendCommand(type, data = null) {
            if(!sendAction) return;
            
            sendAction({
                auth: currentConfig.k,
                type: type,
                data: data,
                profile: userProfile
            });
        }

        function sendMedia(action) {
            // Send the action string directly as data, Host interprets it
            sendCommand('media', { action: action });
        }

        function requestScreenshot() {
            const img = document.getElementById('remote-screen-img');
            if(img) img.style.opacity = '0.5'; // Visual feedback
            sendCommand('requestScreenshot');
        }
        
        function disconnect() {
            // Just reload to go back to device list (session is ephemeral)
            window.location.reload();
        }

        // --- Device Management ---
        function loadDevices() {
            try {
                const raw = localStorage.getItem('waves_client_devices');
                return raw ? JSON.parse(raw) : [];
            } catch(e) { return []; }
        }

        function saveDevice(config, name = null) {
            const devices = loadDevices();
            // Check if exists
            const existingIndex = devices.findIndex(d => d.config.r === config.r);
            
            const deviceName = name || `Device ${config.r.substring(0,4)}`;
            
            if (existingIndex >= 0) {
                devices[existingIndex].config = config; // Update PSK if changed
                devices[existingIndex].lastUsed = Date.now();
            } else {
                devices.push({
                    id: config.r, // Use Room ID as ID
                    name: deviceName,
                    config: config,
                    lastUsed: Date.now()
                });
            }
            localStorage.setItem('waves_client_devices', JSON.stringify(devices));
        }

        function removeDevice(id) {
            if(!confirm("Forget this device?")) return;
            let devices = loadDevices();
            devices = devices.filter(d => d.id !== id);
            localStorage.setItem('waves_client_devices', JSON.stringify(devices));
            renderDeviceList();
        }

        function renderDeviceList() {
            const devices = loadDevices().sort((a, b) => b.lastUsed - a.lastUsed);
            const list = document.getElementById('device-list');
            const container = document.getElementById('device-list-container');
            const inputContainer = document.getElementById('new-device-container');
            
            if (devices.length === 0) {
                container.style.display = 'none';
                inputContainer.style.display = 'block';
                document.getElementById('cancel-add-btn').style.display = 'none';
                return;
            }

            container.style.display = 'block';
            inputContainer.style.display = 'none';
            list.innerHTML = '';

            devices.forEach(dev => {
                const item = document.createElement('div');
                item.className = 'filled-card';
                item.style.cursor = 'pointer';
                item.style.marginBottom = '0';
                
                // Click handler on the text area to connect
                const contentDiv = document.createElement('div');
                contentDiv.style.flex = '1';
                contentDiv.style.display = 'flex';
                contentDiv.style.alignItems = 'center';
                contentDiv.style.gap = '12px';
                contentDiv.innerHTML = `
                    <span class="material-symbols-rounded" style="background:var(--md-sys-color-primary); color:var(--md-sys-color-on-primary); padding:8px; border-radius:50%;">desktop_windows</span>
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-weight:500; font-size:16px;">${dev.name}</span>
                        <span style="font-size:12px; opacity:0.6;">ID: ${dev.id}</span>
                    </div>
                `;
                contentDiv.onclick = () => connect(dev.config);

                // Delete button
                const delBtn = document.createElement('button');
                delBtn.className = 'icon-btn';
                delBtn.innerHTML = '<span class="material-symbols-rounded">cancel</span>';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeDevice(dev.id);
                };

                item.appendChild(contentDiv);
                item.appendChild(delBtn);
                list.appendChild(item);
            });
        }

        function showNewDeviceInput() {
            document.getElementById('device-list-container').style.display = 'none';
            document.getElementById('new-device-container').style.display = 'block';
            // Show cancel button if we have devices to go back to
            const hasDevices = loadDevices().length > 0;
            document.getElementById('cancel-add-btn').style.display = hasDevices ? 'inline-flex' : 'none';
        }

        function showDeviceList() {
            renderDeviceList();
        }

        // --- QR Logic ---
        function normalizeConfig(raw) {
            if (!raw) return null;
            if (raw.roomId && raw.psk) return { r: raw.roomId, k: raw.psk };
            if (raw.r && raw.k) return raw;
            return null;
        }
        
        function onScanSuccess(result) {
            if (!isScanning) return;
            
            // qr-scanner returns an object, we want the .data property
            const decodedText = result.data || result;
        
            try {
                const config = normalizeConfig(JSON.parse(decodedText));
                if(config) {
                    isScanning = false;
                    if(qrScanner) {
                        qrScanner.stop();
                        // Optional: Clear video source to release memory
                        const video = document.getElementById('qr-video');
                        if(video) video.srcObject = null;
                    }
                    connect(config);
                }
            } catch(e) {
                // Ignore invalid codes
            }
        }
        
        document.getElementById('input-code').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
        });
        
        document.getElementById('btn-connect').onclick = () => {
            const code = document.getElementById('input-code').value.trim();
            // Allow code length of 8
            if (code.length < 8) {
                alert("Please enter a valid 8-character PIN");
                return;
            }
            connect({ r: code });
        };

        function renderRemoteNotifications(notifications) {
            const container = document.getElementById('remote-notifications-list');
            const area = document.getElementById('remote-notifications-area');
            container.innerHTML = '';

            if (!notifications || notifications.length === 0) {
                area.style.display = 'none';
                return;
            }

            area.style.display = 'flex';
            
            notifications.forEach(notif => {
                const card = document.createElement('div');
                card.className = 'filled-card';
                
                const icon = notif.icon || 'notifications';
                
                card.innerHTML = `
                    <span class="material-symbols-rounded" style="font-size: 24px;">${icon}</span>
                    <div style="flex:1;">
                        <div style="font-size: 14px; opacity: 0.9;">${notif.text || notif.message}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    
        document.getElementById('remote-file-input').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            document.getElementById('upload-modal').classList.remove('open');
            showLoading("Sending");
            
            const requestId = this.dataset.requestId;
    
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result; // Data URL
                    
                    // Chunking is handled by Trystero implicitly for reasonably sized payloads,
                    // but extremely large files might need manual chunking. 
                    // For wallpapers/images, direct send is usually fine.
                    
                    sendAction({
                        auth: currentConfig.k,
                        type: 'uploadData',
                        data: {
                            name: file.name,
                            type: file.type,
                            data: base64,
                            requestId: requestId
                        }
                    });
                };
                reader.readAsDataURL(file);
            }
            
            // Clear input
            this.value = '';
            setTimeout(hideLoading, 1000);
        });

        // --- Init ---
        function checkInitState() {
            if (!loadUserProfile()) {
                showView('view-profile-setup');
                return;
            }

            // 1. Migration for old users
            const oldConfig = localStorage.getItem('waves_client_config');
            if(oldConfig) {
                try {
                    const c = JSON.parse(oldConfig);
                    if(c.r && c.k) {
                        saveDevice(c);
                        localStorage.removeItem('waves_client_config');
                    }
                } catch(e) {}
            }

            // 2. Load View
            const devices = loadDevices();
            if (devices.length > 0) {
                renderDeviceList();
                _renderView('view-setup');
                history.replaceState({ view: 'view-setup' }, '', '#setup');
            } else {
                showNewDeviceInput();
                _renderView('view-setup');
                history.replaceState({ view: 'view-setup' }, '', '#setup');
            }
        }

        // --- Keep Alive & Visibility Logic ---
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                if (currentConfig && currentConfig.k) {
                    if (room && sendAction) {
                        // Re-trigger hello on wake to ensure host knows we are back
                        const peers = room.getPeers();
                        if (peers.length > 0) {
                            peers.forEach(peerId => {
                                sendAction({ 
                                    type: 'hello', 
                                    auth: currentConfig.k,
                                    profile: userProfile 
                                }, peerId);
                            });
                        } else {
                            connect(currentConfig); // Reconnect if room empty
                        }
                    } else {
                        connect(currentConfig);
                    }
                }
            }
        });

        // Heartbeat Loop
        setInterval(() => {
            if (sendAction && currentConfig && currentConfig.k) {
                sendCommand('ping'); // Keeps NAT open
            }
        }, 3000); 

        // Run on load
        checkInitState();
    </script>
</body>
</html>
