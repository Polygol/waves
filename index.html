<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waves (Beta)</title>
    <link id="favicon" rel="icon" type="image/png" href="favicon.png">
    <meta name="theme-color" content="#141218">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script type="module">
        import { joinRoom, selfId } from 'https://esm.sh/trystero@0.15.1/torrent';
        window.Trystero = { joinRoom, selfId };
        window.dispatchEvent(new Event('trystero-ready'));
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">

    <style>
        /* MD3 Token-ish Variables */
        :root {
            --md-sys-color-background: #141218;
            --md-sys-color-on-background: #E6E1E5;
            --md-sys-color-surface: #1D1B20;
            --md-sys-color-surface-variant: #49454F;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;
            
            --border-radius-lg: 28px;
            --border-radius-md: 16px;
            --border-radius-sm: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* State Views */
        .view { display: none; height: 100%; width: 100%; max-width: 800px; margin: auto; flex-direction: column; padding: 16px; overflow-y: auto; }
        .view.active { display: flex; }

        /* Typography */
        h1 { font-size: 32px; margin: 0 0 16px 0; font-weight: 400; }
        h2 { font-size: 22px; margin: 24px 0 12px 0; font-weight: 400; color: var(--md-sys-color-on-surface); }
        .label-large { font-size: 14px; font-weight: 500; line-height: 20px; }
        .label-medium { font-size: 12px; font-weight: 500; letter-spacing: 0.5px; }

        .code-input {
            background: #49454F;
            border: 1px solid #938F99;
            border-radius: 8px;
            color: white;
            font-family: monospace;
            font-size: 24px;
            text-align: center;
            padding: 16px;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin: 20px 0;
        }

        /* Emoji Grid */
        .emoji-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        .emoji-btn {
            background: #49454F;
            border: none;
            border-radius: 16px;
            font-size: 48px;
            padding: 20px;
            cursor: pointer;
        }
        .emoji-btn:active { background: #D0BCFF; }

        /* Components */
        .card {
            background: var(--md-sys-color-surface);
            border-radius: var(--border-radius-lg);
            padding: 16px;
            margin-bottom: 12px;
        }

        .filled-card {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
            border-radius: var(--border-radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: 100px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 16px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-top: 16px;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface-variant);
            padding: 8px;
            border-radius: 50%;
        }
        .icon-btn:active { background: rgba(255,255,255,0.1); }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: none;
        }

        /* Setup View */
        .setup-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* Dashboard View */
        .top-app-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #FF5449;
        }
        .status-dot.connected { background: #B6F2AF; }

        /* Media Player */
        .media-player {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 28px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 16px;
            margin-bottom: 12px;
        }
        .album-art {
            width: 120px; height: 120px;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .track-info h3 { margin: 0; font-size: 20px; }
        .track-info p { margin: 4px 0 0 0; opacity: 0.8; font-size: 14px; }
        .media-controls {
            display: flex;
            gap: 24px;
            align-items: center;
        }
        .play-pause {
            background: var(--md-sys-color-on-primary-container);
            color: var(--md-sys-color-primary-container);
            width: 64px; height: 64px;
            border-radius: 32px;
            display: flex; align-items: center; justify-content: center;
            border: none;
        }
        
        /* Quick Actions Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .action-card {
            background: var(--md-sys-color-surface-variant);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--md-sys-color-on-surface);
            border: none;
        }
        .action-card:active { background: #5f5b66; }

        /* Brightness Slider */
        .slider-container {
            background: var(--md-sys-color-surface-variant);
            border-radius: 100px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
        }
        input[type=range] {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 20px; height: 20px;
            background: var(--md-sys-color-primary);
            border-radius: 50%;
        }

        /* App Drawer */
        .app-drawer-sheet {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--md-sys-color-surface);
            border-radius: 28px 28px 0 0;
            padding: 24px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 100;
        }
        .app-drawer-sheet.open { transform: translateY(0); }
        
        .app-list-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .app-list-item img { width: 40px; height: 40px; border-radius: 50%; }

        .screenshot-modal {
            position: fixed; inset: 0;
            background: #000;
            display: none;
            align-items: center; justify-content: center;
            z-index: 200;
        }
        .screenshot-modal.open { display: flex; }
        .screenshot-modal img { max-width: 100%; max-height: 100%; }
        .screenshot-modal button {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.2);
            color: white; border: none; padding: 8px; border-radius: 50%;
        }
        .loading-toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(50, 50, 50, 0.9); color: white;
            padding: 12px 24px; border-radius: 50px;
            font-size: 14px; font-weight: 500;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .loading-toast.show { opacity: 1; }
        .mini-app-pill {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-radius: 50px;
            padding: 8px 16px 8px 8px;
            display: none;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .mini-app-pill.visible { display: flex; }
        .mini-app-pill:active { transform: scale(0.98); }
        .mini-app-pill img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .mini-app-pill .info { flex: 1; font-weight: 500; font-size: 16px; }
        .mini-app-pill .action-btn { 
            background: var(--md-sys-color-primary); 
            color: var(--md-sys-color-on-primary);
            border: none; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500;
        }
        /* Segmented Control */
        .segment-control {
            display: flex;
            background: var(--md-sys-color-surface-variant);
            border-radius: 50px;
            padding: 4px;
            margin-bottom: 16px;
        }
        .segment-btn {
            flex: 1;
            background: transparent;
            border: none;
            padding: 10px;
            border-radius: 50px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
        }
        .segment-btn.active {
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        /* Widget Grid */
        .widget-grid-remote {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        .widget-preview {
            background: var(--md-sys-color-surface-variant);
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 1/1;
            position: relative;
        }
        .widget-preview img {
            width: 100%; height: 100%; object-fit: contain;
        }

        /* Live Activity Iframe */
        .remote-activity-frame {
            width: 100%;
            border: none;
            border-radius: 20px;
            margin-bottom: 12px;
            background: #000;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Loading Toast -->
    <div id="loading-toast" class="loading-toast">Loading...</div>

    <!-- SETUP VIEW -->
    <div id="view-setup" class="view active">
        <div class="setup-content">
            <span class="material-symbols-rounded" style="font-size: 64px; color: var(--md-sys-color-primary);">cell_tower</span>
            <h1 style="margin-top:16px;">Waves (Beta)</h1>
            <p style="opacity: 0.7;">Control your Polygol display</p>
            <p style="opacity: 0.7;">Open Settings > Connections > Show Code to start pairing</p>
            <p style="opacity: 0.7; text-align:center;">Enter the code shown on the Display</p>
            
            <input type="text" id="input-code" class="code-input" placeholder="ABCD1234" maxlength="8">
            
            <button class="btn-primary" id="btn-connect" style="margin-top:0;">
                Connect
            </button>
        </div>
    </div>

    <!-- 2. VERIFICATION VIEW -->
    <div id="view-auth" class="view">
        <div class="setup-content">
            <h2>Verification</h2>
            <p style="opacity: 0.7; text-align:center;">Tap the emoji shown on the Display</p>
            <div id="emoji-container" class="emoji-grid"></div>
        </div>
    </div>

    <!-- REMOTE DASHBOARD VIEW -->
    <div id="view-remote" class="view">
        <div class="top-app-bar">
            <div class="connection-status">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text">Connecting...</span>
            </div>
            <button class="icon-btn" onclick="disconnect()">
                <span class="material-symbols-rounded">logout</span>
            </button>
        </div>

        <div id="default-dashboard-ui">
            <!-- Active Mini App Pill -->
            <div id="mini-app-pill" class="mini-app-pill" onclick="openActiveMiniApp()">
                <img id="mini-app-pill-icon" src="">
                <div id="mini-app-pill-name" class="info">App Name</div>
                <div class="action-btn">Open</div>
            </div>

            <!-- Live Activity Container -->
            <div id="remote-live-activity-container"></div>
            
            <!-- Media Player -->
            <div class="media-player">
                <img id="media-art" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="album-art">
                <div class="track-info">
                    <h3 id="media-title">No Media</h3>
                    <p id="media-artist">Not Playing</p>
                </div>
                <div class="media-controls">
                    <button class="icon-btn" onclick="sendMedia('prev')"><span class="material-symbols-rounded" style="font-size: 32px;">skip_previous</span></button>
                    <button class="play-pause" onclick="sendMedia('playPause')"><span class="material-symbols-rounded" style="font-size: 36px;">play_arrow</span></button>
                    <button class="icon-btn" onclick="sendMedia('next')"><span class="material-symbols-rounded" style="font-size: 32px;">skip_next</span></button>
                </div>
            </div>
    
            <div class="grid-2">
                <button class="action-card" onclick="sendCommand('toggleSleep')">
                    <span class="material-symbols-rounded" style="font-size: 32px;">power_settings_new</span>
                    <span class="label-large">Power</span>
                </button>
                <button class="action-card" onclick="sendCommand('home')">
                    <span class="material-symbols-rounded" style="font-size: 32px;">home</span>
                    <span class="label-large">Home</span>
                </button>
                 <button class="action-card" onclick="requestScreenshot()">
                    <span class="material-symbols-rounded" style="font-size: 32px;">screenshot_monitor</span>
                    <span class="label-large">View</span>
                </button>
                 <button class="action-card" onclick="toggleAppDrawer()">
                    <span class="material-symbols-rounded" style="font-size: 32px;">apps</span>
                    <span class="label-large">Apps</span>
                </button>
            </div>
    
            <div class="slider-container">
                <span class="material-symbols-rounded">brightness_5</span>
                <input type="range" id="remote-brightness" min="20" max="100" onchange="sendCommand('setBrightness', this.value)">
            </div>

            <!-- Live Activities & Notifications -->
            <div id="remote-notifications-area" style="display: none; flex-direction: column; gap: 8px; margin-top: 24px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0;">Activity</h2>
                    <button class="icon-btn" onclick="sendCommand('clearNotifications')"><span class="material-symbols-rounded">clear_all</span></button>
                </div>
                <div id="remote-notifications-list" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <!-- Widget Previews -->
            <div id="remote-widgets-area" style="display: none; flex-direction: column; gap: 8px; margin-top: 24px;">
                <h2 style="margin:0; margin-bottom: 12px;">Widgets</h2>
                <div id="remote-widgets-list" class="widget-grid-remote"></div>
            </div>
        </div>

        <div id="app-specific-ui" style="display: none;">
            <div class="top-app-bar" style="margin-bottom: 20px;">
                <button class="icon-btn" onclick="exitAppUI()"><span class="material-symbols-rounded">arrow_back</span></button>
                <span id="app-ui-title" style="font-weight: 500; font-size: 18px;">App Name</span>
                <div style="width: 40px;"></div> <!-- Spacer -->
            </div>
            <div id="app-components-container" style="display: flex; flex-direction: column; gap: 16px;"></div>
        </div>
    </div>

    <!-- App Drawer Sheet -->
    <div id="app-drawer-sheet" class="app-drawer-sheet">
        <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
            <h2>Applications</h2>
            <button class="icon-btn" onclick="toggleAppDrawer()"><span class="material-symbols-rounded">close</span></button>
        </div>
        
        <div class="segment-control">
            <button id="tab-all" class="segment-btn active" onclick="switchDrawerTab('all')">All Apps</button>
            <button id="tab-mini" class="segment-btn" onclick="switchDrawerTab('mini')">Mini Apps</button>
        </div>

        <div id="app-list-container"></div>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshot-view" class="screenshot-modal">
        <button onclick="this.parentElement.classList.remove('open')"><span class="material-symbols-rounded">close</span></button>
        <img id="screenshot-img" src="">
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="screenshot-modal" style="background: rgba(0,0,0,0.9);">
        <div style="text-align: center; width: 100%; padding: 20px;">
            <h2 id="upload-msg">Upload File</h2>
            <p style="opacity: 0.7; margin-bottom: 30px;">The host is requesting a file.</p>
            
            <input type="file" id="remote-file-input" style="display: none;">
            
            <button class="btn-primary" onclick="document.getElementById('remote-file-input').click()" style="width: 200px; margin: auto; position: static; border-radius: 50px;">
                Select File
            </button>
            <br><br>
            <button class="icon-btn" onclick="document.getElementById('upload-modal').classList.remove('open')" style="position: static; border: 1px solid rgba(255,255,255,0.2); border-radius: 50px; width: 48px; height: 48px;">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
    </div>

    <script>
        // Manually set the worker path to the CDN URL to prevent CORS/resolution errors
        if (typeof QrScanner !== 'undefined') {
            QrScanner.WORKER_PATH = 'https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js';
        }
        
        const CONFIG = { appId: 'polygol-connect-v1' };
        let room, sendAction;
        let currentConfig = null;
        let currentRemoteApp = null;
        let pendingAppLaunch = null; // Tracks which app the user requested to view
        let activeMiniApp = null;
        let appListData = [];
        let drawerTab = 'all'; // 'all' or 'mini'

        // --- UI Helpers ---
        function showLoading(msg = 'Loading...') {
            const t = document.getElementById('loading-toast');
            t.innerText = msg;
            t.classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading-toast').classList.remove('show');
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        function setStatus(connected) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if (!dot || !text) return;
            if (connected) {
                dot.classList.add('connected');
                text.innerText = "Connected";
                // Request initial state once connected
                sendCommand('getApps');
                sendCommand('requestScreenshot');
            } else {
                dot.classList.remove('connected');
                text.innerText = "Disconnected";
            }
        }

        function toggleAppDrawer() {
            document.getElementById('app-drawer-sheet').classList.toggle('open');
        }

        function updateMediaUI(metadata, playbackState) {
            if (!metadata) return;
            
            // Update Text
            document.getElementById('media-title').innerText = metadata.title || "Unknown";
            document.getElementById('media-artist').innerText = metadata.artist || "Unknown";
            
            // Update Artwork
            const artImg = document.getElementById('media-art');
            let artSrc = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            if (metadata.artwork && metadata.artwork.length > 0) {
                artSrc = metadata.artwork[0].src;
            }
            artImg.src = artSrc;
    
            // Update Play/Pause Button Icon
            const playBtnIcon = document.querySelector('.play-pause span');
            if (playbackState === 'playing') {
                playBtnIcon.innerText = 'pause';
            } else {
                playBtnIcon.innerText = 'play_arrow';
            }
    
            // --- Native Media Session API (Lock Screen Controls) ---
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: metadata.title || "Polygol Media",
                    artist: metadata.artist || "Remote Control",
                    artwork: [
                        { src: artSrc, sizes: '512x512', type: 'image/png' }
                    ]
                });
    
                // Update playback state for OS
                navigator.mediaSession.playbackState = playbackState || 'none';
    
                // Bind handlers (only need to do this once, but doing it here ensures data availability)
                navigator.mediaSession.setActionHandler('play', () => sendMedia('playPause'));
                navigator.mediaSession.setActionHandler('pause', () => sendMedia('playPause'));
                navigator.mediaSession.setActionHandler('previoustrack', () => sendMedia('prev'));
                navigator.mediaSession.setActionHandler('nexttrack', () => sendMedia('next'));
            }
        }

        function updateBrightnessUI(value) {
            const slider = document.getElementById('remote-brightness');
            if(slider) slider.value = value;
        }
        
        function renderAppList(apps) {
            const container = document.getElementById('app-list-container');
            container.innerHTML = '';
            
            let filteredApps = apps;
            if (drawerTab === 'mini') {
                filteredApps = apps.filter(app => app.hasMiniApp);
            }
            
            if(!filteredApps || filteredApps.length === 0) {
                const msg = drawerTab === 'mini' ? 'No Mini Apps found.' : 'No apps found on host.';
                container.innerHTML = `<p style="text-align:center; opacity:0.5; padding:20px;">${msg}</p>`;
                return;
            }

            filteredApps.forEach(app => {
                const div = document.createElement('div');
                div.className = 'app-list-item';
                div.onclick = () => {
                    // Set pending state and show loading
                    // If Mini App tab is active, we WANT to open the remote UI.
                    if (drawerTab === 'mini') {
                        // For Mini Apps, launch silently in background (if not already running)
                        // and prepare to show the Remote UI
                        sendCommand('launchAppSilently', { url: app.url });
                        pendingAppLaunch = app.name;
                        showLoading(`Opening ${app.name}...`);
                    } else {
                        // Just launching on host, no local loading needed
                        sendCommand('launchApp', { url: app.url });
                    }
                    
                    // 3. Close drawer
                    toggleAppDrawer(); 
                    
                    // 4. Timeout to clear loading if app doesn't respond
                    if (drawerTab === 'mini') {
                        setTimeout(() => {
                            if (pendingAppLaunch === app.name) {
                                hideLoading();
                                pendingAppLaunch = null;
                            }
                        }, 5000);
                    }
                };
                
                const imgHtml = app.icon 
                    ? `<img src="${app.icon}" onerror="this.style.display='none'">` 
                    : '<span class="material-symbols-rounded" style="font-size:32px; opacity:0.7;">apps</span>';

                div.innerHTML = `
                    ${imgHtml}
                    <span style="font-size:16px; font-weight:500;">${app.name}</span>
                `;
                container.appendChild(div);
            });
        }

        // --- Networking ---
        function connect(config) {
            if (!window.Trystero) {
                // Wait for library
                window.addEventListener('trystero-ready', () => connect(config), { once: true });
                return;
            }

            // Case 1: We have a PSK (Restoring session)
            if (config.k) {
                startRemoteSession(config);
            } 
            // Case 2: No PSK (New connection handshake)
            else {
                startHandshake(config.r);
            }
        }

        // 1. New Connection Handshake
        function startHandshake(roomId) {
            console.log("Starting handshake for room:", roomId);
            room = window.Trystero.joinRoom(CONFIG, roomId);
            const [send, get] = room.makeAction('waves-cmd');
            
            // Handle Auth Messages
            get((payload, peerId) => {
                if (payload.type === 'challenge') {
                    renderEmojiGrid(payload.options, peerId, send);
                    showView('view-auth');
                } 
                else if (payload.type === 'authorized') {
                    // Auth Success! Save keys and switch to remote view
                    const newConfig = { r: roomId, k: payload.psk };
                    localStorage.setItem('waves_client_config', JSON.stringify(newConfig));
                    
                    // Cleanup handshake listeners and start full session
                    room.leave(); 
                    setTimeout(() => startRemoteSession(newConfig), 500);
                } 
                else if (payload.type === 'auth_failed') {
                    alert("Incorrect Emoji. Connection refused.");
                    window.location.reload();
                }
            });

            // Send Hello when we find the host
            room.onPeerJoin(peerId => {
                console.log("Host found, saying hello...");
                send({ type: 'hello' }, peerId);
            });
        }

        // 2. Authenticated Session (The actual remote control)
        function startRemoteSession(config) {
            currentConfig = config;
            showView('view-remote');

            console.log("Starting secure session...");
            room = window.Trystero.joinRoom(CONFIG, config.r);
            
            // Setup Channels
            const [sendCmd, getCmd] = room.makeAction('waves-cmd');
            sendAction = sendCmd;
            const [sendUpd, getUpd] = room.makeAction('waves-update');
            
            // Listen for State Updates (Media, Brightness)
            getUpd((payload) => {
                if (payload.type === 'appUI') {
                    // Store active app state regardless of view
                    if (payload.data && payload.data.appName) {
                        activeMiniApp = payload.data;
                    } else {
                        activeMiniApp = null;
                    }
                    updateMiniAppPill();

                    // Only switch view if this is the app the user requested
                    if (payload.data && payload.data.appName) {
                        if (pendingAppLaunch === payload.data.appName || currentRemoteApp === payload.data.appName) {
                            renderAppUI(payload.data.appName, payload.data.components);
                            pendingAppLaunch = null;
                            hideLoading();
                        }
                    } else {
                        // Host cleared UI (e.g. app closed), only exit if we are in that app
                        if (currentRemoteApp) { 
                            exitAppUI(); 
                        }
                    }
                } else if (payload.type === 'appUIUpdate') {
                    // Handle partial updates
                    if (currentRemoteApp && payload.data.appName === currentRemoteApp) {
                        updateAppComponents(payload.data.updates);
                    }
                } else if (payload.type === 'mediaUpdate') {
                    updateMediaUI(payload.data.metadata, payload.data.playbackState);
                } else if (payload.type === 'state') {
                    updateBrightnessUI(payload.data.brightness);
                    if(payload.data.media) {
                        updateMediaUI(payload.data.media, payload.data.mediaState);
                    }
                    // NEW: Handle App UI from full state
                    if (payload.data.appUI) {
                        activeMiniApp = payload.data.appUI;
                        updateMiniAppPill();
                        // If we were waiting for this specific app, open it now
                        if (pendingAppLaunch === payload.data.appUI.appName) {
                            renderAppUI(payload.data.appUI.appName, payload.data.appUI.components);
                            pendingAppLaunch = null;
                            hideLoading();
                        }
                    } else {
                        activeMiniApp = null;
                        updateMiniAppPill();
                    }
                    // NEW: Handle Notifications
                    if (payload.data.notifications) {
                        renderRemoteNotifications(payload.data.notifications);
                    }
                } else if (payload.type === 'notificationUpdate') {
                     // Handle single notification push
                     renderRemoteNotifications(payload.data);
                } else if (payload.type === 'liveActivityStart') {
                    renderLiveActivityIframe(payload.data);
                } else if (payload.type === 'widgetUpdate') {
                    renderWidgetPreviews(payload.data);
                }
            });
            
            // Listen for Data Responses (Screenshots, App Lists)
            getCmd((payload) => {
                if (payload.type === 'screenshot') {
                    const modalImg = document.getElementById('screenshot-img');
                    if(modalImg) {
                        modalImg.src = payload.data;
                        document.getElementById('screenshot-view').classList.add('open');
                    }
                } else if (payload.type === 'appList') {
                    appListData = payload.data;
                    renderAppList(payload.data);
                    updateMiniAppPill(); // Refresh pill in case icon was missing
                } else if (payload.type === 'requestUpload') {
                    const { accept, multiple, requestId } = payload.data;
                    const modal = document.getElementById('upload-modal');
                    const input = document.getElementById('remote-file-input');
                    
                    input.accept = accept || '*/*';
                    input.multiple = multiple || false;
                    // Store requestId on input for retrieval during change event
                    input.dataset.requestId = requestId || '';
                    
                    modal.classList.add('open');
                }
            });

            room.onPeerJoin(() => {
                setStatus(true);
                // Request initial state explicitly to fix reconnection bug!
                sendCommand('getApps');
                sendCommand('requestScreenshot');
                sendCommand('getState'); 
            });

            room.onPeerJoin(() => setStatus(true));
            room.onPeerLeave(() => setStatus(false));
        }
    
        function exitAppUI() {
            document.getElementById('app-specific-ui').style.display = 'none';
            document.getElementById('default-dashboard-ui').style.display = 'block';
            currentRemoteApp = null;
        }
    
        function renderAppUI(appName, components) {
            currentRemoteApp = appName;
            
            // Switch Views
            document.getElementById('default-dashboard-ui').style.display = 'none';
            const container = document.getElementById('app-specific-ui');
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            
            document.getElementById('app-ui-title').innerText = appName;
            const list = document.getElementById('app-components-container');
            list.innerHTML = '';
    
            // Render Components
            components.forEach(comp => {
                let el;
                
                // --- Button Component ---
                if (comp.type === 'button') {
                    el = document.createElement('button');
                    el.id = `comp_${comp.id}`; // Add ID
                    // Style based on 'style' prop: 'filled' (default), 'tonal', 'outlined'
                    if (comp.style === 'outlined') {
                        el.className = 'btn-primary';
                        el.style.background = 'transparent';
                        el.style.border = '1px solid var(--md-sys-color-primary)';
                    } else if (comp.style === 'tonal') {
                        el.className = 'btn-primary';
                        el.style.background = 'var(--md-sys-color-secondary-container)';
                        el.style.color = 'var(--md-sys-color-on-secondary-container)';
                    } else {
                        el.className = 'btn-primary'; // Default filled
                    }
                    
                    // Icon support
                    if (comp.icon) {
                        el.innerHTML = `<span class="material-symbols-rounded">${comp.icon}</span> ${comp.label}`;
                    } else {
                        el.innerText = comp.label;
                    }
                    
                    el.onclick = () => sendAppAction(comp.id);
                }
                
                // --- Text Component ---
                else if (comp.type === 'text') {
                    el = document.createElement('div');
                    el.id = `comp_${comp.id}`; // Add ID
                    el.innerText = comp.content;
                    if (comp.size === 'large') {
                        el.style.fontSize = '32px';
                        el.style.textAlign = 'center';
                    } else if (comp.size === 'medium') {
                        el.style.fontSize = '20px';
                        el.style.opacity = '0.8';
                    } else {
                        el.style.opacity = '0.6';
                    }
                }
    
                // --- Slider Component ---
                else if (comp.type === 'slider') {
                    el = document.createElement('div');
                    el.className = 'slider-container';
                    if (comp.icon) {
                        el.innerHTML = `<span class="material-symbols-rounded">${comp.icon}</span>`;
                    }
                    
                    const input = document.createElement('input');
                    input.id = `comp_${comp.id}`; // Add ID for live updates
                    input.type = 'range';
                    input.min = comp.min || 0;
                    input.max = comp.max || 100;
                    input.value = comp.value || 50;
                    
                    // Use 'input' event for smoother local feedback, sends 'change' on drop
                    input.oninput = (e) => sendAppAction(comp.id, e.target.value);
                    
                    el.appendChild(input);
                }

                // --- Image Component ---
                else if (comp.type === 'image') {
                    el = document.createElement('div');
                    el.style.display = 'flex';
                    el.style.justifyContent = 'center';
                    el.style.marginBottom = '16px';
                    
                    const img = document.createElement('img');
                    img.id = `comp_${comp.id}`;
                    img.src = comp.src || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    img.style.width = comp.width || '200px';
                    img.style.height = comp.height || '200px';
                    img.style.borderRadius = comp.style === 'rounded' ? '16px' : '0';
                    img.style.objectFit = 'cover';
                    img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                    
                    el.appendChild(img);
                }
    
                // --- Grid/Row Layout ---
                else if (comp.type === 'row') {
                    el = document.createElement('div');
                    el.style.display = 'flex';
                    el.style.gap = '12px';
                    el.style.alignItems = 'center';
                    
                    // Recursive rendering for row children
                    if (comp.components && Array.isArray(comp.components)) {
                        // Create a temporary container to render children into, then move them
                        // This reuses the logic without duplicating it, though a refactor to createComponent() would be cleaner.
                        // For this inline approach, we'll iterate manually to support basic nesting.
                        comp.components.forEach(childComp => {
                            // Simplified inline rendering for row items (Buttons & Text mostly)
                            if (childComp.type === 'button') {
                                const btn = document.createElement('button');
                                btn.id = `comp_${childComp.id}`;
                                btn.className = 'btn-primary';
                                btn.style.flex = '1';
                                btn.style.marginTop = '0';
                                if (childComp.style === 'outlined') {
                                    btn.style.background = 'transparent';
                                    btn.style.border = '1px solid var(--md-sys-color-primary)';
                                } else if (childComp.style === 'tonal') {
                                    btn.style.background = 'var(--md-sys-color-secondary-container)';
                                    btn.style.color = 'var(--md-sys-color-on-secondary-container)';
                                }
                                if (childComp.icon) btn.innerHTML = `<span class="material-symbols-rounded">${childComp.icon}</span>`;
                                else btn.innerText = childComp.label;
                                btn.onclick = () => sendAppAction(childComp.id);
                                el.appendChild(btn);
                            }
                            // Handle TEXT in row (Fix for Music App timers)
                            else if (childComp.type === 'text') {
                                const txt = document.createElement('div');
                                txt.id = `comp_${childComp.id}`;
                                txt.innerText = childComp.content;
                                txt.style.fontSize = childComp.size === 'large' ? '24px' : '14px';
                                txt.style.opacity = '0.8';
                                el.appendChild(txt);
                            }
                        });
                    }
                }
                
                // --- Input Component ---
                else if (comp.type === 'input') {
                    el = document.createElement('input');
                    el.type = 'text';
                    el.className = 'code-input'; 
                    el.style.textAlign = 'left';
                    el.style.fontSize = '16px';
                    el.style.letterSpacing = 'normal';
                    el.style.marginBottom = '0';
                    el.style.background = 'var(--md-sys-color-surface-variant)';
                    el.placeholder = comp.placeholder || '';
                    el.value = comp.value || '';
                    
                    el.onchange = (e) => sendAppAction(comp.id, e.target.value);
                }

                // --- List Component ---
                else if (comp.type === 'list') {
                    el = document.createElement('div');
                    el.style.display = 'flex';
                    el.style.flexDirection = 'column';
                    el.style.gap = '8px';

                    comp.items.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'filled-card'; 
                        itemEl.style.marginBottom = '0';
                        itemEl.style.cursor = 'pointer';
                        itemEl.onclick = () => sendAppAction(item.id);

                        let imgHtml = '';
                        if (item.image) {
                            imgHtml = `<img src="${item.image}" style="width: 48px; height: 48px; border-radius: 8px; object-fit: cover;">`;
                        }

                        itemEl.innerHTML = `
                            ${imgHtml}
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 16px;">${item.title}</div>
                                ${item.subtitle ? `<div style="font-size: 13px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.subtitle}</div>` : ''}
                            </div>
                        `;
                        el.appendChild(itemEl);
                    });
                }
    
                if (el) list.appendChild(el);
            });
        }
    
        function sendAppAction(id, value = null) {
            if (!currentRemoteApp) return;
            sendCommand('appAction', { 
                appName: currentRemoteApp, 
                id: id, 
                value: value 
            });
        }

        function updateMiniAppPill() {
            const pill = document.getElementById('mini-app-pill');
            if (!pill) return;

            if (activeMiniApp) {
                const appName = activeMiniApp.appName;
                // Find icon from the cached app list
                const appInfo = appListData.find(a => a.name === appName);
                const iconSrc = appInfo && appInfo.icon ? appInfo.icon : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                
                document.getElementById('mini-app-pill-icon').src = iconSrc;
                document.getElementById('mini-app-pill-name').innerText = appName;
                pill.classList.add('visible');
            } else {
                pill.classList.remove('visible');
            }
        }
        
        function openActiveMiniApp() {
            if (activeMiniApp) {
                renderAppUI(activeMiniApp.appName, activeMiniApp.components);
            }
        }

        function switchDrawerTab(tab) {
            drawerTab = tab;
            document.getElementById('tab-all').classList.toggle('active', tab === 'all');
            document.getElementById('tab-mini').classList.toggle('active', tab === 'mini');
            
            // Always re-render or request fresh data
            if (appListData.length > 0) {
                renderAppList(appListData);
            } else {
                sendCommand('getApps'); // Fetch if missing
            }
        }

        function renderLiveActivityIframe(data) {
            const container = document.getElementById('remote-live-activity-container');
            container.innerHTML = ''; // Clear previous
            if (!data || !data.url) return;

            const iframe = document.createElement('iframe');
            iframe.src = data.url;
            iframe.className = 'remote-activity-frame';
            iframe.style.height = data.height || '120px';
            container.appendChild(iframe);
        }

        function renderWidgetPreviews(widgets) {
            const container = document.getElementById('remote-widgets-list');
            const area = document.getElementById('remote-widgets-area');
            
            if (!widgets || widgets.length === 0) {
                area.style.display = 'none';
                return;
            }
            
            area.style.display = 'flex';
            container.innerHTML = '';
            
            widgets.forEach(w => {
                const el = document.createElement('div');
                el.className = 'widget-preview';
                el.innerHTML = `<img src="${w.img}">`;
                container.appendChild(el);
            });
        }

        function updateAppComponents(updates) {
            for (const [id, value] of Object.entries(updates)) {
                const el = document.getElementById(`comp_${id}`);
                if (!el) continue;

                if (el.tagName === 'INPUT' && el.type === 'range') {
                    el.value = value;
                } else if (el.tagName === 'DIV' && !el.classList.contains('slider-container')) {
                    el.innerText = value;
                } else if (el.tagName === 'IMG') {
                    el.src = value;
                }
                // Add other component types as needed
            }
        }

        function renderEmojiGrid(options, peerId, sendFunc) {
            const container = document.getElementById('emoji-container');
            container.innerHTML = '';
            
            options.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.innerText = emoji;
                btn.onclick = () => {
                    // Send Answer
                    sendFunc({ type: 'verify', answer: emoji }, peerId);
                    container.innerHTML = '<p style="grid-column: span 2; text-align: center; color: white;">Verifying...</p>';
                };
                container.appendChild(btn);
            });
        }

        function sendCommand(type, data = null) {
            if(!sendAction) return;
            sendAction({
                auth: currentConfig.k,
                type: type,
                data: data
            });
        }

        function sendMedia(action) {
            // Send the action string directly as data, Host interprets it
            sendCommand('media', { action: action });
        }

        function requestScreenshot() {
            const img = document.getElementById('remote-screen-img');
            if(img) img.style.opacity = '0.5'; // Visual feedback
            sendCommand('requestScreenshot');
        }
        
        function disconnect() {
            localStorage.removeItem('waves_client_config');
            window.location.reload();
        }

        // --- QR Logic ---
        function normalizeConfig(raw) {
            if (!raw) return null;
            if (raw.roomId && raw.psk) return { r: raw.roomId, k: raw.psk };
            if (raw.r && raw.k) return raw;
            return null;
        }
        
        function onScanSuccess(result) {
            if (!isScanning) return;
            
            // qr-scanner returns an object, we want the .data property
            const decodedText = result.data || result;
        
            try {
                const config = normalizeConfig(JSON.parse(decodedText));
                if(config) {
                    isScanning = false;
                    if(qrScanner) {
                        qrScanner.stop();
                        // Optional: Clear video source to release memory
                        const video = document.getElementById('qr-video');
                        if(video) video.srcObject = null;
                    }
                    connect(config);
                }
            } catch(e) {
                // Ignore invalid codes
            }
        }
        
        document.getElementById('input-code').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase();
        });
        
        document.getElementById('btn-connect').onclick = () => {
            const code = document.getElementById('input-code').value.trim();
            // Allow code length of 8
            if (code.length < 8) {
                alert("Please enter a valid 8-character code");
                return;
            }
            connect({ r: code });
        };

        function renderRemoteNotifications(notifications) {
            const container = document.getElementById('remote-notifications-list');
            const area = document.getElementById('remote-notifications-area');
            container.innerHTML = '';

            if (!notifications || notifications.length === 0) {
                area.style.display = 'none';
                return;
            }

            area.style.display = 'flex';
            
            notifications.forEach(notif => {
                const card = document.createElement('div');
                card.className = 'filled-card';
                
                const icon = notif.icon || 'notifications';
                
                card.innerHTML = `
                    <span class="material-symbols-rounded" style="font-size: 24px;">${icon}</span>
                    <div style="flex:1;">
                        <div style="font-size: 14px; opacity: 0.9;">${notif.text || notif.message}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
    
        document.getElementById('remote-file-input').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            document.getElementById('upload-modal').classList.remove('open');
            showLoading("Uploading...");
            
            const requestId = this.dataset.requestId;
    
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result; // Data URL
                    
                    // Chunking is handled by Trystero implicitly for reasonably sized payloads,
                    // but extremely large files might need manual chunking. 
                    // For wallpapers/images, direct send is usually fine.
                    
                    sendAction({
                        auth: currentConfig.k,
                        type: 'uploadData',
                        data: {
                            name: file.name,
                            type: file.type,
                            data: base64,
                            requestId: requestId
                        }
                    });
                };
                reader.readAsDataURL(file);
            }
            
            // Clear input
            this.value = '';
            setTimeout(hideLoading, 1000);
        });

        // --- Init ---
        const saved = localStorage.getItem('waves_client_config');
        if(saved) {
            try {
                const config = JSON.parse(saved);
                if(config.r && config.k) connect(config);
            } catch(e) {
                console.error("Bad config", e);
            }
        }
    </script>
</body>
</html>
