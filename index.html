<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Waves Remote</title>
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Dependencies -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    
    <!-- Trystero Module -->
    <script type="module">
        import { joinRoom, selfId } from 'https://esm.sh/trystero@0.15.1/torrent';
        window.Trystero = { joinRoom, selfId };
        window.dispatchEvent(new Event('trystero-ready'));
    </script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

    <style>
        :root {
            --bg: #000000;
            --card-bg: #1c1c1e;
            --accent: #0a84ff;
            --text: #ffffff;
            --text-sec: #8e8e93;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Views */
        .view { display: none; height: 100%; flex-direction: column; }
        .view.active { display: flex; }

        /* Setup View */
        .setup-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        #qr-reader { 
            width: 100%; 
            min-height: 250px; /* Important: Reserve space for camera */
            border-radius: 20px; 
            overflow: hidden; 
            border: 1px solid #333; 
            background: #111;
        }
        
        .btn {
            background: var(--card-bg);
            color: var(--accent);
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); filter: brightness(1.2); }
        .btn.primary { background: var(--accent); color: white; }

        /* Remote View */
        .remote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .status-dot {
            width: 10px; height: 10px;
            background: #333;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-dot.connected { background: #32d74b; box-shadow: 0 0 10px #32d74b; }

        .preview-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 10px;
            margin-bottom: 20px;
            position: relative;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #remote-screen-img {
            width: 100%;
            border-radius: 16px;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .control-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .media-row {
            grid-column: span 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: white;
            padding: 10px;
        }
        .icon-btn span { font-size: 32px; }
        .play-btn span { font-size: 48px; }

        .slider-container {
            grid-column: span 2;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
        }
        
        input[type=range] {
            flex: 1;
            accent-color: var(--accent);
            height: 6px;
            border-radius: 3px;
        }

    </style>
</head>
<body>

    <!-- 1. SETUP VIEW -->
    <div id="view-setup" class="view active">
        <div class="setup-container">
            <span class="material-symbols-rounded" style="font-size: 64px; color: var(--accent);">waves</span>
            <h1>Connect to Polygol</h1>
            <p style="color: var(--text-sec); text-align: center;">Scan the QR code found in Polygol Settings > Connect</p>
            
            <div id="qr-reader"></div>
            
            <button class="btn primary" id="btn-scan">Scan QR Code</button>
            <input type="text" id="manual-code" placeholder="Or paste code here" style="background: #333; border:none; padding: 15px; border-radius: 10px; color: white; width: 100%; text-align: center;">
            <button class="btn" id="btn-manual">Connect Manually</button>
        </div>
    </div>

    <!-- 2. REMOTE VIEW -->
    <div id="view-remote" class="view">
        <div class="remote-header">
            <div style="display: flex; align-items: center;">
                <div id="status-dot" class="status-dot"></div>
                <span id="status-text" style="font-weight: 600;">Connecting...</span>
            </div>
            <button class="icon-btn" onclick="disconnect()"><span class="material-symbols-rounded">logout</span></button>
        </div>

        <!-- Screenshot Preview -->
        <div class="preview-card" onclick="requestScreenshot()">
            <img id="remote-screen-img" src="" alt="Tap to refresh">
            <span style="position: absolute; color: white; font-size: 12px; bottom: 15px; pointer-events: none;">Tap to Refresh</span>
        </div>

        <div class="control-grid">
            <!-- Power -->
            <div class="control-card" onclick="sendCommand('blackout')">
                <span class="material-symbols-rounded" style="font-size: 32px; color: #ff453a;">power_settings_new</span>
                <span>Sleep</span>
            </div>
            <div class="control-card" onclick="sendCommand('wake')">
                <span class="material-symbols-rounded" style="font-size: 32px; color: #32d74b;">wb_sunny</span>
                <span>Wake</span>
            </div>

            <!-- Media -->
            <div class="control-card media-row">
                <button class="icon-btn" onclick="sendMedia('prev')"><span class="material-symbols-rounded">skip_previous</span></button>
                <button class="icon-btn play-btn" onclick="sendMedia('playPause')"><span class="material-symbols-rounded">play_circle</span></button>
                <button class="icon-btn" onclick="sendMedia('next')"><span class="material-symbols-rounded">skip_next</span></button>
            </div>

            <!-- Brightness -->
            <div class="control-card slider-container">
                <span class="material-symbols-rounded">brightness_low</span>
                <input type="range" min="20" max="100" onchange="sendCommand('setBrightness', this.value)">
                <span class="material-symbols-rounded">brightness_high</span>
            </div>
        </div>
    </div>

<script>
        const CONFIG = { appId: 'polygol-connect-v1' };
        let room, sendAction;
        let currentConfig = null;
        let html5QrCode = null;
        let isScanning = false;

        // --- UI Logic ---
        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function setStatus(connected) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if(connected) {
                dot.classList.add('connected');
                text.innerText = "Connected";
                requestScreenshot(); // Get initial view
            } else {
                dot.classList.remove('connected');
                text.innerText = "Disconnected";
            }
        }

        // --- Connection Logic ---
        function connect(config) {
            // Wait for Trystero if it's not loaded yet
            if (!window.Trystero) {
                document.getElementById('status-text').innerText = "Loading Libraries...";
                window.addEventListener('trystero-ready', () => connect(config), { once: true });
                return;
            }

            currentConfig = config;
            localStorage.setItem('waves_client_config', JSON.stringify(config));
            showView('view-remote');

            room = window.Trystero.joinRoom(CONFIG, config.r);
            const [send, get] = room.makeAction('waves-cmd');
            sendAction = send;

            // Handle incoming (Screenshots)
            get((payload, peerId) => {
                if (payload.type === 'screenshot') {
                    document.getElementById('remote-screen-img').src = payload.data;
                    document.getElementById('remote-screen-img').style.opacity = '1';
                }
            });

            room.onPeerJoin(() => setStatus(true));
            room.onPeerLeave(() => setStatus(false));
        }

        function disconnect() {
            localStorage.removeItem('waves_client_config');
            window.location.reload();
        }

        function sendCommand(type, data = null) {
            if(!sendAction) return;
            // Standard payload with Auth Key
            sendAction({
                auth: currentConfig.k,
                type: type,
                data: data
            });
        }

        function sendMedia(action) {
            sendCommand('media', { action: action });
        }

        function requestScreenshot() {
            document.getElementById('remote-screen-img').style.opacity = '0.3'; // Visual feedback
            sendCommand('requestScreenshot');
        }

        // --- Scanner Logic ---
        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return;

            try {
                const config = JSON.parse(decodedText);
                
                // Check if it looks like a valid Waves config
                if(config.r && config.k) {
                    console.log("Valid code found, connecting...");
                    
                    // 1. Lock scanning to prevent duplicates
                    isScanning = false; 
                    
                    // 2. Connect IMMEDIATELY (Don't wait for camera to stop)
                    connect(config);

                    // 3. Stop camera in background
                    if(html5QrCode) {
                        html5QrCode.stop().then(() => {
                            document.getElementById('qr-reader').innerHTML = "";
                        }).catch(err => {
                            console.warn("Camera stop warning (ignored):", err);
                            document.getElementById('qr-reader').innerHTML = "";
                        });
                    }
                }
            } catch(e) {
                // Invalid JSON. 
                // We do NOT stop scanning here, so the user can try again 
                // without tapping the button again.
                console.log("Ignored invalid QR code:", decodedText);
            }
        }

        document.getElementById('btn-scan').onclick = () => {
            if (isScanning) return;
            
            html5QrCode = new Html5Qrcode("qr-reader");
            isScanning = true;
            document.getElementById('btn-scan').style.display = 'none';
            
            // Use responsive box size based on viewport
            const qrBoxSize = Math.min(window.innerWidth - 50, 250);

            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: qrBoxSize, height: qrBoxSize } },
                onScanSuccess,
                (errorMessage) => { /* Ignore frame errors */ }
            ).catch(err => {
                isScanning = false;
                document.getElementById('btn-scan').style.display = 'block';
                alert("Camera failed: " + err);
            });
        };

        document.getElementById('btn-manual').onclick = () => {
            const val = document.getElementById('manual-code').value;
            try {
                const config = JSON.parse(val);
                connect(config);
            } catch(e) { alert("Invalid JSON code"); }
        };

        // --- Init ---
        const saved = localStorage.getItem('waves_client_config');
        if(saved) {
            connect(JSON.parse(saved));
        }
    </script>
</body>
</html>
